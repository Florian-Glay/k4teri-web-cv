import{L as lo,a as fn,F as Fs,C as yt,S as co,P as On,D as as,M as q,b as Bs,V as et,T as uo,I as fo,c as gn,d as po,B as $n,R as mo,e as An,f as Ns,g as es,h as rs,i as Ss,j as ho,k as ls,l as ze,s as bs,m as go,n as cs,o as wo,p as _e,q as yo,r as _o,t as xo,u as us,G as vn,v as Gt,w as $,O as To,x as Gs,A as Mo,y as vo,z as So,E as qs,H as bo,J as Ws,K as Eo,N as Ao,Q as Lo,U as Ro,W as Io,X as Do,Y as zo,Z as Ho,_ as ko,$ as Co,a0 as fs,a1 as Oo,a2 as Po,a3 as Fo,a4 as Bo,a5 as ds,a6 as L,a7 as No,a8 as Us,a9 as Go,aa as qo,ab as Pn,ac as Yt,ad as Qt,ae as Es,af as Wo,ag as Uo,ah as Vo,ai as ps,aj as Ko,ak as Xo,al as jo}from"./threeBundle.f920c408.js";import{W as Yo,V as pe,S as Qo,B as $e,P as Zo,a as Zt,Q as Jo}from"./cannonBundle.7f10d7e3.js";const $o=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}};$o();class ei extends lo{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(n){return new oi(n)}),this.register(function(n){return new ai(n)}),this.register(function(n){return new ri(n)}),this.register(function(n){return new ii(n)}),this.register(function(n){return new ni(n)}),this.register(function(n){return new li(n)})}load(t,n,o,s){const i=this;let a;this.resourcePath!==""?a=this.resourcePath:this.path!==""?a=this.path:a=fn.extractUrlBase(t),this.manager.itemStart(t);const l=function(c){s?s(c):console.error(c),i.manager.itemError(t),i.manager.itemEnd(t)},r=new Fs(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(t,function(c){try{i.parse(c,a,function(f){n(f),i.manager.itemEnd(t)},l)}catch(f){l(f)}},o,l)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return this.pluginCallbacks.indexOf(t)===-1&&this.pluginCallbacks.push(t),this}unregister(t){return this.pluginCallbacks.indexOf(t)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,n,o,s){let i;const a={},l={};if(typeof t=="string")i=t;else if(fn.decodeText(new Uint8Array(t,0,4))===Vs){try{a[H.KHR_BINARY_GLTF]=new ci(t)}catch(u){s&&s(u);return}i=a[H.KHR_BINARY_GLTF].content}else i=fn.decodeText(new Uint8Array(t));const r=JSON.parse(i);if(r.asset===void 0||r.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new _i(r,{path:n||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let f=0;f<this.pluginCallbacks.length;f++){const u=this.pluginCallbacks[f](c);l[u.name]=u,a[u.name]=!0}if(r.extensionsUsed)for(let f=0;f<r.extensionsUsed.length;++f){const u=r.extensionsUsed[f],p=r.extensionsRequired||[];switch(u){case H.KHR_MATERIALS_UNLIT:a[u]=new si;break;case H.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:a[u]=new di;break;case H.KHR_DRACO_MESH_COMPRESSION:a[u]=new ui(r,this.dracoLoader);break;case H.KHR_TEXTURE_TRANSFORM:a[u]=new fi;break;case H.KHR_MESH_QUANTIZATION:a[u]=new pi;break;default:p.indexOf(u)>=0&&l[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}c.setExtensions(a),c.setPlugins(l),c.parse(o,s)}}function ti(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const H={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class ni{constructor(t){this.parser=t,this.name=H.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,n=this.parser.json.nodes||[];for(let o=0,s=n.length;o<s;o++){const i=n[o];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&t._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(t){const n=this.parser,o="light:"+t;let s=n.cache.get(o);if(s)return s;const i=n.json,r=((i.extensions&&i.extensions[this.name]||{}).lights||[])[t];let c;const f=new yt(16777215);r.color!==void 0&&f.fromArray(r.color);const u=r.range!==void 0?r.range:0;switch(r.type){case"directional":c=new as(f),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new On(f),c.distance=u;break;case"spot":c=new co(f),c.distance=u,r.spot=r.spot||{},r.spot.innerConeAngle=r.spot.innerConeAngle!==void 0?r.spot.innerConeAngle:0,r.spot.outerConeAngle=r.spot.outerConeAngle!==void 0?r.spot.outerConeAngle:Math.PI/4,c.angle=r.spot.outerConeAngle,c.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return c.position.set(0,0,0),c.decay=2,r.intensity!==void 0&&(c.intensity=r.intensity),c.name=n.createUniqueName(r.name||"light_"+t),s=Promise.resolve(c),n.cache.add(o,s),s}createNodeAttachment(t){const n=this,o=this.parser,i=o.json.nodes[t],l=(i.extensions&&i.extensions[this.name]||{}).light;return l===void 0?null:this._loadLight(l).then(function(r){return o._getNodeRef(n.cache,l,r)})}}class si{constructor(){this.name=H.KHR_MATERIALS_UNLIT}getMaterialType(){return q}extendParams(t,n,o){const s=[];t.color=new yt(1,1,1),t.opacity=1;const i=n.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const a=i.baseColorFactor;t.color.fromArray(a),t.opacity=a[3]}i.baseColorTexture!==void 0&&s.push(o.assignTexture(t,"map",i.baseColorTexture))}return Promise.all(s)}}class oi{constructor(t){this.parser=t,this.name=H.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const o=this.parser.json.materials[t];return!o.extensions||!o.extensions[this.name]?null:Bs}extendMaterialParams(t,n){const o=this.parser,s=o.json.materials[t];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],a=s.extensions[this.name];if(a.clearcoatFactor!==void 0&&(n.clearcoat=a.clearcoatFactor),a.clearcoatTexture!==void 0&&i.push(o.assignTexture(n,"clearcoatMap",a.clearcoatTexture)),a.clearcoatRoughnessFactor!==void 0&&(n.clearcoatRoughness=a.clearcoatRoughnessFactor),a.clearcoatRoughnessTexture!==void 0&&i.push(o.assignTexture(n,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),a.clearcoatNormalTexture!==void 0&&(i.push(o.assignTexture(n,"clearcoatNormalMap",a.clearcoatNormalTexture)),a.clearcoatNormalTexture.scale!==void 0)){const l=a.clearcoatNormalTexture.scale;n.clearcoatNormalScale=new et(l,-l)}return Promise.all(i)}}class ii{constructor(t){this.parser=t,this.name=H.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const o=this.parser.json.materials[t];return!o.extensions||!o.extensions[this.name]?null:Bs}extendMaterialParams(t,n){const o=this.parser,s=o.json.materials[t];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],a=s.extensions[this.name];return a.transmissionFactor!==void 0&&(n.transmission=a.transmissionFactor),a.transmissionTexture!==void 0&&i.push(o.assignTexture(n,"transmissionMap",a.transmissionTexture)),Promise.all(i)}}class ai{constructor(t){this.parser=t,this.name=H.KHR_TEXTURE_BASISU}loadTexture(t){const n=this.parser,o=n.json,s=o.textures[t];if(!s.extensions||!s.extensions[this.name])return null;const i=s.extensions[this.name],a=o.images[i.source],l=n.options.ktx2Loader;if(!l){if(o.extensionsRequired&&o.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return n.loadTextureImage(t,a,l)}}class ri{constructor(t){this.parser=t,this.name=H.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const n=this.name,o=this.parser,s=o.json,i=s.textures[t];if(!i.extensions||!i.extensions[n])return null;const a=i.extensions[n],l=s.images[a.source];let r=o.textureLoader;if(l.uri){const c=o.options.manager.getHandler(l.uri);c!==null&&(r=c)}return this.detectSupport().then(function(c){if(c)return o.loadTextureImage(t,l,r);if(s.extensionsRequired&&s.extensionsRequired.indexOf(n)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return o.loadTexture(t)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){const n=new Image;n.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",n.onload=n.onerror=function(){t(n.height===1)}})),this.isSupported}}class li{constructor(t){this.name=H.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const n=this.parser.json,o=n.bufferViews[t];if(o.extensions&&o.extensions[this.name]){const s=o.extensions[this.name],i=this.parser.getDependency("buffer",s.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([i,a.ready]).then(function(l){const r=s.byteOffset||0,c=s.byteLength||0,f=s.count,u=s.byteStride,p=new ArrayBuffer(f*u),m=new Uint8Array(l[0],r,c);return a.decodeGltfBuffer(new Uint8Array(p),f,u,m,s.mode,s.filter),p})}else return null}}const Vs="glTF",$t=12,As={JSON:1313821514,BIN:5130562};class ci{constructor(t){this.name=H.KHR_BINARY_GLTF,this.content=null,this.body=null;const n=new DataView(t,0,$t);if(this.header={magic:fn.decodeText(new Uint8Array(t.slice(0,4))),version:n.getUint32(4,!0),length:n.getUint32(8,!0)},this.header.magic!==Vs)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const o=this.header.length-$t,s=new DataView(t,$t);let i=0;for(;i<o;){const a=s.getUint32(i,!0);i+=4;const l=s.getUint32(i,!0);if(i+=4,l===As.JSON){const r=new Uint8Array(t,$t+i,a);this.content=fn.decodeText(r)}else if(l===As.BIN){const r=$t+i;this.body=t.slice(r,r+a)}i+=a}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class ui{constructor(t,n){if(!n)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=H.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=n,this.dracoLoader.preload()}decodePrimitive(t,n){const o=this.json,s=this.dracoLoader,i=t.extensions[this.name].bufferView,a=t.extensions[this.name].attributes,l={},r={},c={};for(const f in a){const u=ns[f]||f.toLowerCase();l[u]=a[f]}for(const f in t.attributes){const u=ns[f]||f.toLowerCase();if(a[f]!==void 0){const p=o.accessors[t.attributes[f]],m=mn[p.componentType];c[u]=m,r[u]=p.normalized===!0}}return n.getDependency("bufferView",i).then(function(f){return new Promise(function(u){s.decodeDracoFile(f,function(p){for(const m in p.attributes){const h=p.attributes[m],T=r[m];T!==void 0&&(h.normalized=T)}u(p)},l,c)})})}}class fi{constructor(){this.name=H.KHR_TEXTURE_TRANSFORM}extendTexture(t,n){return t=t.clone(),n.offset!==void 0&&t.offset.fromArray(n.offset),n.rotation!==void 0&&(t.rotation=n.rotation),n.scale!==void 0&&t.repeat.fromArray(n.scale),n.texCoord!==void 0&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),t.needsUpdate=!0,t}}class ts extends ls{constructor(t){super(),this.isGLTFSpecularGlossinessMaterial=!0;const n=["#ifdef USE_SPECULARMAP","	uniform sampler2D specularMap;","#endif"].join(`
`),o=["#ifdef USE_GLOSSINESSMAP","	uniform sampler2D glossinessMap;","#endif"].join(`
`),s=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","	vec4 texelSpecular = texture2D( specularMap, vUv );","	texelSpecular = sRGBToLinear( texelSpecular );","	// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","	specularFactor *= texelSpecular.rgb;","#endif"].join(`
`),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","	vec4 texelGlossiness = texture2D( glossinessMap, vUv );","	// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","	glossinessFactor *= texelGlossiness.a;","#endif"].join(`
`),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join(`
`),l={specular:{value:new yt().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=l,this.onBeforeCompile=function(r){for(const c in l)r.uniforms[c]=l[c];r.fragmentShader=r.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",n).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",s).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return l.specular.value},set:function(r){l.specular.value=r}},specularMap:{get:function(){return l.specularMap.value},set:function(r){l.specularMap.value=r,r?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return l.glossiness.value},set:function(r){l.glossiness.value=r}},glossinessMap:{get:function(){return l.glossinessMap.value},set:function(r){l.glossinessMap.value=r,r?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(t)}copy(t){return super.copy(t),this.specularMap=t.specularMap,this.specular.copy(t.specular),this.glossinessMap=t.glossinessMap,this.glossiness=t.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class di{constructor(){this.name=H.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return ts}extendParams(t,n,o){const s=n.extensions[this.name];t.color=new yt(1,1,1),t.opacity=1;const i=[];if(Array.isArray(s.diffuseFactor)){const a=s.diffuseFactor;t.color.fromArray(a),t.opacity=a[3]}if(s.diffuseTexture!==void 0&&i.push(o.assignTexture(t,"map",s.diffuseTexture)),t.emissive=new yt(0,0,0),t.glossiness=s.glossinessFactor!==void 0?s.glossinessFactor:1,t.specular=new yt(1,1,1),Array.isArray(s.specularFactor)&&t.specular.fromArray(s.specularFactor),s.specularGlossinessTexture!==void 0){const a=s.specularGlossinessTexture;i.push(o.assignTexture(t,"glossinessMap",a)),i.push(o.assignTexture(t,"specularMap",a))}return Promise.all(i)}createMaterial(t){const n=new ts(t);return n.fog=!0,n.color=t.color,n.map=t.map===void 0?null:t.map,n.lightMap=null,n.lightMapIntensity=1,n.aoMap=t.aoMap===void 0?null:t.aoMap,n.aoMapIntensity=1,n.emissive=t.emissive,n.emissiveIntensity=1,n.emissiveMap=t.emissiveMap===void 0?null:t.emissiveMap,n.bumpMap=t.bumpMap===void 0?null:t.bumpMap,n.bumpScale=1,n.normalMap=t.normalMap===void 0?null:t.normalMap,n.normalMapType=uo,t.normalScale&&(n.normalScale=t.normalScale),n.displacementMap=null,n.displacementScale=1,n.displacementBias=0,n.specularMap=t.specularMap===void 0?null:t.specularMap,n.specular=t.specular,n.glossinessMap=t.glossinessMap===void 0?null:t.glossinessMap,n.glossiness=t.glossiness,n.alphaMap=null,n.envMap=t.envMap===void 0?null:t.envMap,n.envMapIntensity=1,n.refractionRatio=.98,n}}class pi{constructor(){this.name=H.KHR_MESH_QUANTIZATION}}class Xt extends Eo{constructor(t,n,o,s){super(t,n,o,s)}copySampleValue_(t){const n=this.resultBuffer,o=this.sampleValues,s=this.valueSize,i=t*s*3+s;for(let a=0;a!==s;a++)n[a]=o[i+a];return n}}Xt.prototype.beforeStart_=Xt.prototype.copySampleValue_;Xt.prototype.afterEnd_=Xt.prototype.copySampleValue_;Xt.prototype.interpolate_=function(e,t,n,o){const s=this.resultBuffer,i=this.sampleValues,a=this.valueSize,l=a*2,r=a*3,c=o-t,f=(n-t)/c,u=f*f,p=u*f,m=e*r,h=m-r,T=-2*p+3*u,y=p-u,g=1-T,D=y-u+f;for(let k=0;k!==a;k++){const we=i[h+k+a],_=i[h+k+l]*c,X=i[m+k+a],te=i[m+k]*c;s[k]=g*we+D*_+T*X+y*te}return s};const Be={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},mn={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Ls={9728:Ao,9729:An,9984:Lo,9985:Ro,9986:Io,9987:Ns},Rs={33071:Do,33648:zo,10497:es},Is={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ns={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},nt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},mi={CUBICSPLINE:void 0,LINEAR:Gs,STEP:Ho},Xn={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function Ds(e,t){return typeof e!="string"||e===""?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function hi(e){return e.DefaultMaterial===void 0&&(e.DefaultMaterial=new ls({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:ko})),e.DefaultMaterial}function en(e,t,n){for(const o in n.extensions)e[o]===void 0&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[o]=n.extensions[o])}function At(e,t){t.extras!==void 0&&(typeof t.extras=="object"?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function gi(e,t,n){let o=!1,s=!1;for(let l=0,r=t.length;l<r;l++){const c=t[l];if(c.POSITION!==void 0&&(o=!0),c.NORMAL!==void 0&&(s=!0),o&&s)break}if(!o&&!s)return Promise.resolve(e);const i=[],a=[];for(let l=0,r=t.length;l<r;l++){const c=t[l];if(o){const f=c.POSITION!==void 0?n.getDependency("accessor",c.POSITION):e.attributes.position;i.push(f)}if(s){const f=c.NORMAL!==void 0?n.getDependency("accessor",c.NORMAL):e.attributes.normal;a.push(f)}}return Promise.all([Promise.all(i),Promise.all(a)]).then(function(l){const r=l[0],c=l[1];return o&&(e.morphAttributes.position=r),s&&(e.morphAttributes.normal=c),e.morphTargetsRelative=!0,e})}function wi(e,t){if(e.updateMorphTargets(),t.weights!==void 0)for(let n=0,o=t.weights.length;n<o;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let o=0,s=n.length;o<s;o++)e.morphTargetDictionary[n[o]]=o}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function yi(e){const t=e.extensions&&e.extensions[H.KHR_DRACO_MESH_COMPRESSION];let n;return t?n="draco:"+t.bufferView+":"+t.indices+":"+zs(t.attributes):n=e.indices+":"+zs(e.attributes)+":"+e.mode,n}function zs(e){let t="";const n=Object.keys(e).sort();for(let o=0,s=n.length;o<s;o++)t+=n[o]+":"+e[n[o]]+";";return t}function ss(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class _i{constructor(t={},n={}){this.json=t,this.extensions={},this.plugins={},this.options=n,this.cache=new ti,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},typeof createImageBitmap!="undefined"&&/Firefox/.test(navigator.userAgent)===!1?this.textureLoader=new fo(this.options.manager):this.textureLoader=new gn(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Fs(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,n){const o=this,s=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll(function(a){return a._markDefs&&a._markDefs()}),Promise.all(this._invokeAll(function(a){return a.beforeRoot&&a.beforeRoot()})).then(function(){return Promise.all([o.getDependencies("scene"),o.getDependencies("animation"),o.getDependencies("camera")])}).then(function(a){const l={scene:a[0][s.scene||0],scenes:a[0],animations:a[1],cameras:a[2],asset:s.asset,parser:o,userData:{}};en(i,l,s),At(l,s),Promise.all(o._invokeAll(function(r){return r.afterRoot&&r.afterRoot(l)})).then(function(){t(l)})}).catch(n)}_markDefs(){const t=this.json.nodes||[],n=this.json.skins||[],o=this.json.meshes||[];for(let s=0,i=n.length;s<i;s++){const a=n[s].joints;for(let l=0,r=a.length;l<r;l++)t[a[l]].isBone=!0}for(let s=0,i=t.length;s<i;s++){const a=t[s];a.mesh!==void 0&&(this._addNodeRef(this.meshCache,a.mesh),a.skin!==void 0&&(o[a.mesh].isSkinnedMesh=!0)),a.camera!==void 0&&this._addNodeRef(this.cameraCache,a.camera)}}_addNodeRef(t,n){n!==void 0&&(t.refs[n]===void 0&&(t.refs[n]=t.uses[n]=0),t.refs[n]++)}_getNodeRef(t,n,o){if(t.refs[n]<=1)return o;const s=o.clone();return s.name+="_instance_"+t.uses[n]++,s}_invokeOne(t){const n=Object.values(this.plugins);n.push(this);for(let o=0;o<n.length;o++){const s=t(n[o]);if(s)return s}return null}_invokeAll(t){const n=Object.values(this.plugins);n.unshift(this);const o=[];for(let s=0;s<n.length;s++){const i=t(n[s]);i&&o.push(i)}return o}getDependency(t,n){const o=t+":"+n;let s=this.cache.get(o);if(!s){switch(t){case"scene":s=this.loadScene(n);break;case"node":s=this.loadNode(n);break;case"mesh":s=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(n)});break;case"accessor":s=this.loadAccessor(n);break;case"bufferView":s=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(n)});break;case"buffer":s=this.loadBuffer(n);break;case"material":s=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(n)});break;case"texture":s=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(n)});break;case"skin":s=this.loadSkin(n);break;case"animation":s=this.loadAnimation(n);break;case"camera":s=this.loadCamera(n);break;default:throw new Error("Unknown type: "+t)}this.cache.add(o,s)}return s}getDependencies(t){let n=this.cache.get(t);if(!n){const o=this,s=this.json[t+(t==="mesh"?"es":"s")]||[];n=Promise.all(s.map(function(i,a){return o.getDependency(t,a)})),this.cache.add(t,n)}return n}loadBuffer(t){const n=this.json.buffers[t],o=this.fileLoader;if(n.type&&n.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+n.type+" buffer type is not supported.");if(n.uri===void 0&&t===0)return Promise.resolve(this.extensions[H.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(i,a){o.load(Ds(n.uri,s.path),i,void 0,function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+n.uri+'".'))})})}loadBufferView(t){const n=this.json.bufferViews[t];return this.getDependency("buffer",n.buffer).then(function(o){const s=n.byteLength||0,i=n.byteOffset||0;return o.slice(i,i+s)})}loadAccessor(t){const n=this,o=this.json,s=this.json.accessors[t];if(s.bufferView===void 0&&s.sparse===void 0)return Promise.resolve(null);const i=[];return s.bufferView!==void 0?i.push(this.getDependency("bufferView",s.bufferView)):i.push(null),s.sparse!==void 0&&(i.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(i).then(function(a){const l=a[0],r=Is[s.type],c=mn[s.componentType],f=c.BYTES_PER_ELEMENT,u=f*r,p=s.byteOffset||0,m=s.bufferView!==void 0?o.bufferViews[s.bufferView].byteStride:void 0,h=s.normalized===!0;let T,y;if(m&&m!==u){const g=Math.floor(p/m),D="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+g+":"+s.count;let k=n.cache.get(D);k||(T=new c(l,g*m,s.count*m/f),k=new po(T,m/f),n.cache.add(D,k)),y=new Co(k,r,p%m/f,h)}else l===null?T=new c(s.count*r):T=new c(l,p,s.count*r),y=new $n(T,r,h);if(s.sparse!==void 0){const g=Is.SCALAR,D=mn[s.sparse.indices.componentType],k=s.sparse.indices.byteOffset||0,we=s.sparse.values.byteOffset||0,_=new D(a[1],k,s.sparse.count*g),X=new c(a[2],we,s.sparse.count*r);l!==null&&(y=new $n(y.array.slice(),y.itemSize,y.normalized));for(let te=0,He=_.length;te<He;te++){const Fe=_[te];if(y.setX(Fe,X[te*r]),r>=2&&y.setY(Fe,X[te*r+1]),r>=3&&y.setZ(Fe,X[te*r+2]),r>=4&&y.setW(Fe,X[te*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return y})}loadTexture(t){const n=this.json,o=this.options,s=n.textures[t],i=n.images[s.source];let a=this.textureLoader;if(i.uri){const l=o.manager.getHandler(i.uri);l!==null&&(a=l)}return this.loadTextureImage(t,i,a)}loadTextureImage(t,n,o){const s=this,i=this.json,a=this.options,l=i.textures[t],r=self.URL||self.webkitURL;let c=n.uri,f=!1,u=!0;if(n.mimeType==="image/jpeg"&&(u=!1),n.bufferView!==void 0)c=s.getDependency("bufferView",n.bufferView).then(function(p){if(n.mimeType==="image/png"){const h=new DataView(p,25,1).getUint8(0,!1);u=h===6||h===4||h===3}f=!0;const m=new Blob([p],{type:n.mimeType});return c=r.createObjectURL(m),c});else if(n.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");return Promise.resolve(c).then(function(p){return new Promise(function(m,h){let T=m;o.isImageBitmapLoader===!0&&(T=function(y){m(new fs(y))}),o.load(Ds(p,a.path),T,void 0,h)})}).then(function(p){f===!0&&r.revokeObjectURL(c),p.flipY=!1,l.name&&(p.name=l.name),u||(p.format=mo);const h=(i.samplers||{})[l.sampler]||{};return p.magFilter=Ls[h.magFilter]||An,p.minFilter=Ls[h.minFilter]||Ns,p.wrapS=Rs[h.wrapS]||es,p.wrapT=Rs[h.wrapT]||es,s.associations.set(p,{type:"textures",index:t}),p})}assignTexture(t,n,o){const s=this;return this.getDependency("texture",o.index).then(function(i){if(o.texCoord!==void 0&&o.texCoord!=0&&!(n==="aoMap"&&o.texCoord==1)&&console.warn("THREE.GLTFLoader: Custom UV set "+o.texCoord+" for texture "+n+" not yet supported."),s.extensions[H.KHR_TEXTURE_TRANSFORM]){const a=o.extensions!==void 0?o.extensions[H.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=s.associations.get(i);i=s.extensions[H.KHR_TEXTURE_TRANSFORM].extendTexture(i,a),s.associations.set(i,l)}}t[n]=i})}assignFinalMaterial(t){const n=t.geometry;let o=t.material;const s=n.attributes.tangent!==void 0,i=n.attributes.color!==void 0,a=n.attributes.normal===void 0,l=t.isSkinnedMesh===!0,r=Object.keys(n.morphAttributes).length>0,c=r&&n.morphAttributes.normal!==void 0;if(t.isPoints){const f="PointsMaterial:"+o.uuid;let u=this.cache.get(f);u||(u=new rs,Ss.prototype.copy.call(u,o),u.color.copy(o.color),u.map=o.map,u.sizeAttenuation=!1,this.cache.add(f,u)),o=u}else if(t.isLine){const f="LineBasicMaterial:"+o.uuid;let u=this.cache.get(f);u||(u=new ho,Ss.prototype.copy.call(u,o),u.color.copy(o.color),this.cache.add(f,u)),o=u}if(s||i||a||l||r){let f="ClonedMaterial:"+o.uuid+":";o.isGLTFSpecularGlossinessMaterial&&(f+="specular-glossiness:"),l&&(f+="skinning:"),s&&(f+="vertex-tangents:"),i&&(f+="vertex-colors:"),a&&(f+="flat-shading:"),r&&(f+="morph-targets:"),c&&(f+="morph-normals:");let u=this.cache.get(f);u||(u=o.clone(),l&&(u.skinning=!0),i&&(u.vertexColors=!0),a&&(u.flatShading=!0),r&&(u.morphTargets=!0),c&&(u.morphNormals=!0),s&&(u.vertexTangents=!0,u.normalScale&&(u.normalScale.y*=-1),u.clearcoatNormalScale&&(u.clearcoatNormalScale.y*=-1)),this.cache.add(f,u),this.associations.set(u,this.associations.get(o))),o=u}o.aoMap&&n.attributes.uv2===void 0&&n.attributes.uv!==void 0&&n.setAttribute("uv2",n.attributes.uv),t.material=o}getMaterialType(){return ls}loadMaterial(t){const n=this,o=this.json,s=this.extensions,i=o.materials[t];let a;const l={},r=i.extensions||{},c=[];if(r[H.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const u=s[H.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=u.getMaterialType(),c.push(u.extendParams(l,i,n))}else if(r[H.KHR_MATERIALS_UNLIT]){const u=s[H.KHR_MATERIALS_UNLIT];a=u.getMaterialType(),c.push(u.extendParams(l,i,n))}else{const u=i.pbrMetallicRoughness||{};if(l.color=new yt(1,1,1),l.opacity=1,Array.isArray(u.baseColorFactor)){const p=u.baseColorFactor;l.color.fromArray(p),l.opacity=p[3]}u.baseColorTexture!==void 0&&c.push(n.assignTexture(l,"map",u.baseColorTexture)),l.metalness=u.metallicFactor!==void 0?u.metallicFactor:1,l.roughness=u.roughnessFactor!==void 0?u.roughnessFactor:1,u.metallicRoughnessTexture!==void 0&&(c.push(n.assignTexture(l,"metalnessMap",u.metallicRoughnessTexture)),c.push(n.assignTexture(l,"roughnessMap",u.metallicRoughnessTexture))),a=this._invokeOne(function(p){return p.getMaterialType&&p.getMaterialType(t)}),c.push(Promise.all(this._invokeAll(function(p){return p.extendMaterialParams&&p.extendMaterialParams(t,l)})))}i.doubleSided===!0&&(l.side=ze);const f=i.alphaMode||Xn.OPAQUE;return f===Xn.BLEND?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,f===Xn.MASK&&(l.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&a!==q&&(c.push(n.assignTexture(l,"normalMap",i.normalTexture)),l.normalScale=new et(1,-1),i.normalTexture.scale!==void 0&&l.normalScale.set(i.normalTexture.scale,-i.normalTexture.scale)),i.occlusionTexture!==void 0&&a!==q&&(c.push(n.assignTexture(l,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(l.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&a!==q&&(l.emissive=new yt().fromArray(i.emissiveFactor)),i.emissiveTexture!==void 0&&a!==q&&c.push(n.assignTexture(l,"emissiveMap",i.emissiveTexture)),Promise.all(c).then(function(){let u;return a===ts?u=s[H.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):u=new a(l),i.name&&(u.name=i.name),u.map&&(u.map.encoding=bs),u.emissiveMap&&(u.emissiveMap.encoding=bs),At(u,i),n.associations.set(u,{type:"materials",index:t}),i.extensions&&en(s,u,i),u})}createUniqueName(t){const n=go.sanitizeNodeName(t||"");let o=n;for(let s=1;this.nodeNamesUsed[o];++s)o=n+"_"+s;return this.nodeNamesUsed[o]=!0,o}loadGeometries(t){const n=this,o=this.extensions,s=this.primitiveCache;function i(l){return o[H.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(l,n).then(function(r){return Hs(r,l,n)})}const a=[];for(let l=0,r=t.length;l<r;l++){const c=t[l],f=yi(c),u=s[f];if(u)a.push(u.promise);else{let p;c.extensions&&c.extensions[H.KHR_DRACO_MESH_COMPRESSION]?p=i(c):p=Hs(new cs,c,n),s[f]={primitive:c,promise:p},a.push(p)}}return Promise.all(a)}loadMesh(t){const n=this,o=this.json,s=this.extensions,i=o.meshes[t],a=i.primitives,l=[];for(let r=0,c=a.length;r<c;r++){const f=a[r].material===void 0?hi(this.cache):this.getDependency("material",a[r].material);l.push(f)}return l.push(n.loadGeometries(a)),Promise.all(l).then(function(r){const c=r.slice(0,r.length-1),f=r[r.length-1],u=[];for(let m=0,h=f.length;m<h;m++){const T=f[m],y=a[m];let g;const D=c[m];if(y.mode===Be.TRIANGLES||y.mode===Be.TRIANGLE_STRIP||y.mode===Be.TRIANGLE_FAN||y.mode===void 0)g=i.isSkinnedMesh===!0?new wo(T,D):new _e(T,D),g.isSkinnedMesh===!0&&!g.geometry.attributes.skinWeight.normalized&&g.normalizeSkinWeights(),y.mode===Be.TRIANGLE_STRIP?g.geometry=ks(g.geometry,Oo):y.mode===Be.TRIANGLE_FAN&&(g.geometry=ks(g.geometry,Ws));else if(y.mode===Be.LINES)g=new yo(T,D);else if(y.mode===Be.LINE_STRIP)g=new _o(T,D);else if(y.mode===Be.LINE_LOOP)g=new xo(T,D);else if(y.mode===Be.POINTS)g=new us(T,D);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+y.mode);Object.keys(g.geometry.morphAttributes).length>0&&wi(g,i),g.name=n.createUniqueName(i.name||"mesh_"+t),At(g,i),y.extensions&&en(s,g,y),n.assignFinalMaterial(g),u.push(g)}if(u.length===1)return u[0];const p=new vn;for(let m=0,h=u.length;m<h;m++)p.add(u[m]);return p})}loadCamera(t){let n;const o=this.json.cameras[t],s=o[o.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return o.type==="perspective"?n=new Gt($.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):o.type==="orthographic"&&(n=new To(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),o.name&&(n.name=this.createUniqueName(o.name)),At(n,o),Promise.resolve(n)}loadSkin(t){const n=this.json.skins[t],o={joints:n.joints};return n.inverseBindMatrices===void 0?Promise.resolve(o):this.getDependency("accessor",n.inverseBindMatrices).then(function(s){return o.inverseBindMatrices=s,o})}loadAnimation(t){const o=this.json.animations[t],s=[],i=[],a=[],l=[],r=[];for(let c=0,f=o.channels.length;c<f;c++){const u=o.channels[c],p=o.samplers[u.sampler],m=u.target,h=m.node!==void 0?m.node:m.id,T=o.parameters!==void 0?o.parameters[p.input]:p.input,y=o.parameters!==void 0?o.parameters[p.output]:p.output;s.push(this.getDependency("node",h)),i.push(this.getDependency("accessor",T)),a.push(this.getDependency("accessor",y)),l.push(p),r.push(m)}return Promise.all([Promise.all(s),Promise.all(i),Promise.all(a),Promise.all(l),Promise.all(r)]).then(function(c){const f=c[0],u=c[1],p=c[2],m=c[3],h=c[4],T=[];for(let g=0,D=f.length;g<D;g++){const k=f[g],we=u[g],_=p[g],X=m[g],te=h[g];if(k===void 0)continue;k.updateMatrix(),k.matrixAutoUpdate=!0;let He;switch(nt[te.path]){case nt.weights:He=Bo;break;case nt.rotation:He=Fo;break;case nt.position:case nt.scale:default:He=Po;break}const Fe=k.name?k.name:k.uuid,wn=X.interpolation!==void 0?mi[X.interpolation]:Gs,bt=[];nt[te.path]===nt.weights?k.traverse(function(me){me.isMesh===!0&&me.morphTargetInfluences&&bt.push(me.name?me.name:me.uuid)}):bt.push(Fe);let tt=_.array;if(_.normalized){const me=ss(tt.constructor),xe=new Float32Array(tt.length);for(let Te=0,vs=tt.length;Te<vs;Te++)xe[Te]=tt[Te]*me;tt=xe}for(let me=0,xe=bt.length;me<xe;me++){const Te=new He(bt[me]+"."+nt[te.path],we.array,tt,wn);X.interpolation==="CUBICSPLINE"&&(Te.createInterpolant=function(ro){return new Xt(this.times,this.values,this.getValueSize()/3,ro)},Te.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),T.push(Te)}}const y=o.name?o.name:"animation_"+t;return new Mo(y,void 0,T)})}createNodeMesh(t){const n=this.json,o=this,s=n.nodes[t];return s.mesh===void 0?null:o.getDependency("mesh",s.mesh).then(function(i){const a=o._getNodeRef(o.meshCache,s.mesh,i);return s.weights!==void 0&&a.traverse(function(l){if(!!l.isMesh)for(let r=0,c=s.weights.length;r<c;r++)l.morphTargetInfluences[r]=s.weights[r]}),a})}loadNode(t){const n=this.json,o=this.extensions,s=this,i=n.nodes[t],a=i.name?s.createUniqueName(i.name):"";return function(){const l=[],r=s._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(t)});return r&&l.push(r),i.camera!==void 0&&l.push(s.getDependency("camera",i.camera).then(function(c){return s._getNodeRef(s.cameraCache,i.camera,c)})),s._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(t)}).forEach(function(c){l.push(c)}),Promise.all(l)}().then(function(l){let r;if(i.isBone===!0?r=new vo:l.length>1?r=new vn:l.length===1?r=l[0]:r=new So,r!==l[0])for(let c=0,f=l.length;c<f;c++)r.add(l[c]);if(i.name&&(r.userData.name=i.name,r.name=a),At(r,i),i.extensions&&en(o,r,i),i.matrix!==void 0){const c=new qs;c.fromArray(i.matrix),r.applyMatrix4(c)}else i.translation!==void 0&&r.position.fromArray(i.translation),i.rotation!==void 0&&r.quaternion.fromArray(i.rotation),i.scale!==void 0&&r.scale.fromArray(i.scale);return s.associations.set(r,{type:"nodes",index:t}),r})}loadScene(t){const n=this.json,o=this.extensions,s=this.json.scenes[t],i=this,a=new vn;s.name&&(a.name=i.createUniqueName(s.name)),At(a,s),s.extensions&&en(o,a,s);const l=s.nodes||[],r=[];for(let c=0,f=l.length;c<f;c++)r.push(Ks(l[c],a,n,i));return Promise.all(r).then(function(){return a})}}function Ks(e,t,n,o){const s=n.nodes[e];return o.getDependency("node",e).then(function(i){if(s.skin===void 0)return i;let a;return o.getDependency("skin",s.skin).then(function(l){a=l;const r=[];for(let c=0,f=a.joints.length;c<f;c++)r.push(o.getDependency("node",a.joints[c]));return Promise.all(r)}).then(function(l){return i.traverse(function(r){if(!r.isMesh)return;const c=[],f=[];for(let u=0,p=l.length;u<p;u++){const m=l[u];if(m){c.push(m);const h=new qs;a.inverseBindMatrices!==void 0&&h.fromArray(a.inverseBindMatrices.array,u*16),f.push(h)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',a.joints[u])}r.bind(new bo(c,f),r.matrixWorld)}),i})}).then(function(i){t.add(i);const a=[];if(s.children){const l=s.children;for(let r=0,c=l.length;r<c;r++){const f=l[r];a.push(Ks(f,i,n,o))}}return Promise.all(a)})}function xi(e,t,n){const o=t.attributes,s=new ds;if(o.POSITION!==void 0){const l=n.json.accessors[o.POSITION],r=l.min,c=l.max;if(r!==void 0&&c!==void 0){if(s.set(new L(r[0],r[1],r[2]),new L(c[0],c[1],c[2])),l.normalized){const f=ss(mn[l.componentType]);s.min.multiplyScalar(f),s.max.multiplyScalar(f)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=t.targets;if(i!==void 0){const l=new L,r=new L;for(let c=0,f=i.length;c<f;c++){const u=i[c];if(u.POSITION!==void 0){const p=n.json.accessors[u.POSITION],m=p.min,h=p.max;if(m!==void 0&&h!==void 0){if(r.setX(Math.max(Math.abs(m[0]),Math.abs(h[0]))),r.setY(Math.max(Math.abs(m[1]),Math.abs(h[1]))),r.setZ(Math.max(Math.abs(m[2]),Math.abs(h[2]))),p.normalized){const T=ss(mn[p.componentType]);r.multiplyScalar(T)}l.max(r)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(l)}e.boundingBox=s;const a=new No;s.getCenter(a.center),a.radius=s.min.distanceTo(s.max)/2,e.boundingSphere=a}function Hs(e,t,n){const o=t.attributes,s=[];function i(a,l){return n.getDependency("accessor",a).then(function(r){e.setAttribute(l,r)})}for(const a in o){const l=ns[a]||a.toLowerCase();l in e.attributes||s.push(i(o[a],l))}if(t.indices!==void 0&&!e.index){const a=n.getDependency("accessor",t.indices).then(function(l){e.setIndex(l)});s.push(a)}return At(e,t),xi(e,t,n),Promise.all(s).then(function(){return t.targets!==void 0?gi(e,t.targets,n):e})}function ks(e,t){let n=e.getIndex();if(n===null){const a=[],l=e.getAttribute("position");if(l!==void 0){for(let r=0;r<l.count;r++)a.push(r);e.setIndex(a),n=e.getIndex()}else return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e}const o=n.count-2,s=[];if(t===Ws)for(let a=1;a<=o;a++)s.push(n.getX(0)),s.push(n.getX(a)),s.push(n.getX(a+1));else for(let a=0;a<o;a++)a%2===0?(s.push(n.getX(a)),s.push(n.getX(a+1)),s.push(n.getX(a+2))):(s.push(n.getX(a+2)),s.push(n.getX(a+1)),s.push(n.getX(a)));s.length/3!==o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(s),i}const E=1/60;let os="";var F="select",N="start",x=0,be=5,dt=[{name:"player_1",rank:1},{name:"player_2",rank:2},{name:"player_3",rank:3},{name:"player_4",rank:4},{name:"ordinateur_1",rank:5},{name:"ordinateur_2",rank:6},{name:"ordinateur_3",rank:7},{name:"ordinateur_4",rank:8},{name:"ordinateur_5",rank:9},{name:"ordinateur_6",rank:10},{name:"ordinateur_7",rank:11},{name:"ordinateur_8",rank:12}];let ye=[null,null,null,null],at=null;var W=1,ie=1,b=[{x:-2003,z:-505},{x:-1975,z:-465},{x:-1947,z:-425},{x:-1919,z:-385},{x:-1891,z:-345},{x:-1863,z:-305},{x:-1989,z:-270},{x:-1961,z:-230},{x:-1933,z:-190},{x:-1905,z:-150},{x:-1877,z:-105},{x:-1850,z:-65}];const Ti=document.getElementById("chat-icon"),jn=document.getElementById("chat-window"),Sn=document.getElementById("chat-input");Ti.addEventListener("click",()=>{jn.classList.contains("active")?jn.classList.remove("active"):(jn.classList.add("active"),Sn.focus())});Sn.addEventListener("keydown",e=>{e.key==="Enter"&&(os=Sn.value,Sn.value="")});const M=new Us,R=new Gt(75,window.innerWidth/window.innerHeight,.1,1e6);R.position.set(0,150,300);const ue=new Gt(75,window.innerWidth/window.innerHeight,.1,1e6);ue.position.set(0,150,300);const Ie=new Gt(75,window.innerWidth/window.innerHeight,.1,1e6);Ie.position.set(0,150,300);const zt=new Gt(75,window.innerWidth/window.innerHeight,.1,1e6);zt.position.set(0,150,300);const ms=new Gt(75,window.innerWidth/window.innerHeight,.1,1e6);ms.position.set(200,200,200);ms.lookAt(new L(0,0,0));const w=new Go({antialias:!0});w.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(w.domElement);const C=new Us,Mt=document.createElement("canvas");Mt.width=512;Mt.height=512;const hs=Mt.getContext("2d"),gs=hs.createLinearGradient(0,0,Mt.width,Mt.height);gs.addColorStop(0,"#0033cc");gs.addColorStop(1,"#66ccff");hs.fillStyle=gs;hs.fillRect(0,0,Mt.width,Mt.height);const Mi=new fs(Mt);C.background=Mi;const v=new Gt(75,window.innerWidth/window.innerHeight,1,5e4);v.position.set(0,0,359);v.lookAt(new L(0,0,0));const Xs=1e4,bn=new Float32Array(Xs*3),rt=2e4;for(let e=0;e<Xs;e++)bn[e*3]=Math.random()*rt-rt/2,bn[e*3+1]=Math.random()*rt-rt/2,bn[e*3+2]=Math.random()*rt-rt/2;const ws=new cs;ws.setAttribute("position",new $n(bn,3));const vi=new rs({color:16777215,size:2,sizeAttenuation:!0}),Si=new us(ws,vi);C.add(Si);const bi=new On(16777215,.8);bi.position.set(5,500,5);const Ei=new On(16777215,1);Ei.position.set(5,0,5);const Ai=new On(16777215,1);Ai.position.set(5,0,5);M.add(new qo(16777215,.7));const ys=new as(16777215,1);ys.position.set(0,300,0);ys.castShadow=!0;M.add(ys);const _s=new as(16777215,1);_s.position.set(window.innerWidth*1,window.innerHeight*1,100);_s.castShadow=!0;C.add(_s);M.background=new gn().load("Image/smoky-watercolor-cloud-background.jpg");const le=new Yo({gravity:new pe(0,-9.82,0)});le.broadphase=new Qo(le);le.allowSleep=!1;const Li=new Pn(500,500),Ri=new q({color:16777215,side:ze,wireframe:!1}),Ee=new _e(Li,Ri);Ee.visible=!1;M.add(Ee);const Ae=new $e({shape:new Zo,type:$e.STATIC,position:new pe(0,-25,0)});Ae.quaternion.setFromEuler(-Math.PI/2,0,0);le.addBody(Ae);const Le=new ei;Le.load("3D_Model/background.glb",e=>{const t=e.scene;t.scale.set(1,1,1),t.position.set(0,-360,0),t.traverse(n=>{n.isMesh&&(n.frustumCulled=!1)}),M.add(t)},void 0,console.error);const Ii=new Yt(17,5,25),Di=new q({color:65280,wireframe:!0}),S=new _e(Ii,Di);S.name="player_1";S.visible=!1;M.add(S);const A=new $e({mass:200,shape:new Zt(new pe(8,3,12.5)),position:new pe(b[11].x,-20,b[11].z)});A.quaternion.setFromEuler(0,-Math.PI,0);A.fixedRotation=!0;A.updateMassProperties();le.addBody(A);const Fn="3D_Model/mario_arma.glb",js="3D_Model/car_5.glb",Bn="3D_Model/voiture_1.glb",Ys="3D_Model/voiture_2.glb",vt=[Fn,js,Bn,Ys],Nn=[Fn,Bn];function Gn(e){let t;if(e===1)t=Fn;else if(e===2)t=js;else if(e===3)t=Bn;else if(e===4)t=Ys;else{console.error("Mode de kart non reconnu :",e);return}return t}let ae;const Yn={};function zi(e,t){Yn[e]?t(Yn[e].clone()):Le.load(e,n=>{Yn[e]=n.scene,t(n.scene.clone())},void 0,console.error)}function qn(e,t){zi(e,n=>{e===Fn||e===Bn?n.scale.set(1,1,1):n.scale.set(100,100,100),n.position.set(-2e3,-20,-500),n.rotation.y=Math.PI,n.traverse(o=>{if(o.isMesh){o.frustumCulled=!1;const s=o.material,i=s&&s.map||null;o.material=new q({map:i,color:s&&s.color||16777215,side:ze}),s&&s.metalness!==void 0&&(s.roughness=.8,s.metalness=0,s.envMapIntensity=.5,s.toneMapped=!0,s.emissive.set(0))}}),t(n)})}function Wn(e){let t;t=Gn(e),qn(t,n=>{ae&&M.remove(ae),ae=n,M.add(ae)})}const Hi=new Yt(17,5,25),ki=new q({color:65280,wireframe:!0}),B=new _e(Hi,ki);B.name="player_2";B.visible=!1;M.add(B);const V=new $e({mass:200,shape:new Zt(new pe(8,3,12.5)),position:new pe(b[10].x,-20,b[10].z)});V.quaternion.setFromEuler(0,-Math.PI,0);V.fixedRotation=!0;V.updateMassProperties();le.addBody(V);let G;Le.load("3D_Model/mario_arma.glb",e=>{G=e.scene,G.position.set(-1950,-500,65),G.rotation.y=Math.PI,G.traverse(t=>{if(t.isMesh){t.frustumCulled=!1;const n=t.material;n&&n.metalness!==void 0&&(n.roughness=.8,n.metalness=0,n.envMapIntensity=.5,n.toneMapped=!0,n.emissive.set(0))}}),M.add(G)},void 0,console.error);function xs(e){let t;t=Gn(e),qn(t,n=>{G&&M.remove(G),G=n,M.add(G)})}const Ci=new Yt(17,5,25),Oi=new q({color:65280,wireframe:!0}),J=new _e(Ci,Oi);J.visible=!1;J.name="player_3";M.add(J);const ee=new $e({mass:200,shape:new Zt(new pe(8,3,12.5)),position:new pe(b[9].x,-20,b[9].z)});ee.quaternion.setFromEuler(0,-Math.PI,0);ee.fixedRotation=!0;ee.updateMassProperties();le.addBody(ee);let K;Le.load("3D_Model/voiture_1.glb",e=>{K=e.scene,K.position.set(-1650,-500,300),K.rotation.y=Math.PI,K.traverse(t=>{if(t.isMesh){t.frustumCulled=!1;const n=t.material;n&&n.metalness!==void 0&&(n.roughness=.8,n.metalness=0,n.envMapIntensity=.5,n.toneMapped=!0,n.emissive.set(0))}}),M.add(K)},void 0,console.error);function Qs(e){let t;t=Gn(e),qn(t,n=>{K&&M.remove(K),K=n,M.add(K)})}const Pi=new Yt(17,5,25),Fi=new q({color:65280,wireframe:!0}),ve=new _e(Pi,Fi);ve.visible=!1;ve.name="player_4";M.add(ve);const fe=new $e({mass:200,shape:new Zt(new pe(8,3,12.5)),position:new pe(b[8].x,-20,b[8].z)});fe.quaternion.setFromEuler(0,-Math.PI,0);fe.fixedRotation=!0;fe.updateMassProperties();le.addBody(fe);let j;Le.load("3D_Model/mario_arma.glb",e=>{j=e.scene,j.position.set(-1650,-500,300),j.rotation.y=Math.PI,j.traverse(t=>{if(t.isMesh){t.frustumCulled=!1;const n=t.material;n&&n.metalness!==void 0&&(n.roughness=.8,n.metalness=0,n.envMapIntensity=.5,n.toneMapped=!0,n.emissive.set(0))}}),M.add(j)},void 0,console.error);function Bi(e){let t;t=Gn(e),qn(t,n=>{j&&M.remove(j),j=n,M.add(j)})}let Ut,Vt;Le.load("3D_Model/road.glb",e=>{Ut=e.scene,Ut.name="circuit",Ut.position.set(0,-360,0),Ut.traverse(t=>{t.isMesh&&(t.frustumCulled=!1)}),M.add(Ut),new ds().setFromObject(Ut)},void 0,console.error);Le.load("3D_Model/dirt.glb",e=>{Vt=e.scene,Vt.name="dirt",Vt.position.set(0,-360,0),Vt.traverse(t=>{t.isMesh&&(t.frustumCulled=!1)}),M.add(Vt),new ds().setFromObject(Vt)},void 0,console.error);let Kt={};function Qn(e,t,n=5){const o=Kt[e];if(!o||!o.imageData)return;const{boundingBox:s,imageData:i,imgWidth:a,imgHeight:l}=o,r=[];for(let p=0;p<a;p+=n)for(let m=0;m<l;m+=n){const h=(m*a+p)*4;if(i.data[h+3]>128){const y=p/a,g=m/l,D=s.minX+y*(s.maxX-s.minX),k=s.minZ+(1-g)*(s.maxZ-s.minZ),we=-25;r.push(D,we+.1,k)}}const c=new cs;c.setAttribute("position",new Ko(r,3));const f=new rs({color:t,size:1}),u=new us(c,f);M.add(u)}function qt(e,t,n,o,s){const i=new Pn(o.width,o.depth),a=new gn().load(t,f=>{const u=f.image,p=document.createElement("canvas");p.width=u.width,p.height=u.height;const m=p.getContext("2d");m.drawImage(u,0,0);const h=m.getImageData(0,0,u.width,u.height);Kt[e].imageData=h,Kt[e].imgWidth=u.width,Kt[e].imgHeight=u.height,s&&(e==="road"?Qn(e,16711680):e==="dirt"?Qn(e,65280):Qn(e,255))});a.format=Vo;const l=new q({map:a,transparent:!1,wireframe:!1}),r=new _e(i,l);r.rotation.x=-Math.PI/2,r.position.set(n.x,n.y,n.z),r.name=e,M.add(r);const c={minX:n.x-o.width/2,maxX:n.x+o.width/2,minZ:n.z-o.depth/2,maxZ:n.z+o.depth/2,y:n.y};Kt[e]={mesh:r,boundingBox:c,imageData:null,imgWidth:0,imgHeight:0}}qt("road","Image/road.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);qt("dirt","Image/dirt.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);qt("boostTrap","Image/boostTrap.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);qt("step_1","Image/step_1.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);qt("step_2","Image/step_2.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);qt("step_3","Image/step_3.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);qt("step_4","Image/step_4.png",{x:-45,y:-45,z:-240},{width:4600,depth:4020},!1);function he(e,t){const n=Kt[e];if(!n||!n.imageData)return!1;const o=n.boundingBox,s=t.position;if(s.x<o.minX||s.x>o.maxX||s.z<o.minZ||s.z>o.maxZ)return!1;const i=(s.x-o.minX)/(o.maxX-o.minX),a=1-(s.z-o.minZ)/(o.maxZ-o.minZ),l=Math.floor(i*n.imgWidth),c=(Math.floor(a*n.imgHeight)*n.imgWidth+l)*4;return n.imageData.data[c+3]>200}function En(e){let t=1;return he("road",e)?t=1:he("dirt",e)&&(t=.5),t}var se=[[!1,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!1,!1]],ce=[0,0,0,0];function Oe(e){var t=e.name=="player_1"?0:e.name=="player_2"?1:e.name=="player_3"?2:3;he("step_4",e)&&(se[t][0]||(se[t][0]=!0),se[t][0]&&se[t][1]&&se[t][2]&&se[t][3]&&(se[t]=[!1,!1,!1,!1],console.log("Tour Complet"),ce[t]+=1,console.log(ce),F=="runsolo"&&ce[0]==ie,F=="runsplit"&&ce[0]>=ie&&ce[1]>=ie,F=="runsplit3"&&ce[0]>=ie&&ce[1]>=ie&&ce[2]>=ie,F=="runsplit4"&&ce[0]>=ie&&ce[1]>=ie&&ce[2]>=ie&&ce[3]>=ie)),he("step_1",e)&&se[t][0]&&!se[t][1]&&(se[t][1]=!0),he("step_2",e)&&se[t][1]&&!se[t][2]&&(se[t][2]=!0),he("step_3",e)&&se[t][2]&&!se[t][3]&&(se[t][3]=!0)}const I={z:!1,s:!1,q:!1,d:!1,o:!1,l:!1,k:!1,m:!1,g:!1,b:!1,v:!1,n:!1,arrowleft:!1,arrowright:!1,arrowup:!1,arrowdown:!1},st=200,Me=1;let Ln=0,Rn=0,Ue=!1,Ve=!1,nn=0,Lt=!1,Ht=0;var lt=0,sn=!1,pt=!1;let In=0,Dn=0,Ke=!1,Xe=!1,on=0,Rt=!1,kt=0;var ct=0,an=!1,mt=!1;let zn=0,Hn=0,je=!1,Ye=!1,rn=0,It=!1,Ct=0;var ut=0,ln=!1,ht=!1;let Ts=0,dn=0,Qe=!1,Ze=!1,cn=0,Dt=!1,Ot=0;var ft=0,un=!1,gt=!1,Pt=0,Ft=0,Bt=0,Nt=0;function Ni(){Ln=0,Rn=0,Ue=!1,Ve=!1,nn=0,Lt=!1,Ht=0,lt=0,sn=!1,pt=!1,In=0,Dn=0,Ke=!1,Xe=!1,on=0,Rt=!1,kt=0,ct=0,an=!1,mt=!1,zn=0,Hn=0,je=!1,Ye=!1,rn=0,It=!1,Ct=0,ut=0,ln=!1,ht=!1,Ts=0,dn=0,Qe=!1,Ze=!1,cn=0,Dt=!1,Ot=0,ft=0,un=!1,gt=!1,Pt=0,Ft=0,Bt=0,Nt=0,A.angularVelocity.y=0,V.angularVelocity.y=0,ee.angularVelocity.y=0,fe.angularVelocity.y=0,A.velocity.x=0,V.velocity.x=0,ee.velocity.x=0,fe.velocity.x=0,A.velocity.z=0,V.velocity.z=0,ee.velocity.z=0,fe.velocity.z=0,A.quaternion.setFromEuler(0,-Math.PI,0),V.quaternion.setFromEuler(0,-Math.PI,0),ee.quaternion.setFromEuler(0,-Math.PI,0),fe.quaternion.setFromEuler(0,-Math.PI,0),se=[[!1,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!1,!1]],ce=[0,0,0,0],A.position.set(b[11].x,-20,b[11].z),V.position.set(b[10].x,-20,b[10].z),ee.position.set(b[9].x,-20,b[9].z),fe.position.set(b[8].x,-20,b[8].z),wt=["run","run","run","run"],ye=[null,null,null,null],at=null,dt=[]}window.addEventListener("keydown",e=>{if(F=="select")return;const t=e.key.toLowerCase();if(t==="q"){const n=Date.now();Ln&&n-Ln<st&&(Ue=!0),I.q=!0}if(t==="d"){const n=Date.now();Rn&&n-Rn<st&&(Ve=!0),I.d=!0}if(t==="k"){const n=Date.now();In&&n-In<st&&(Ke=!0),I.k=!0}if(t==="m"){const n=Date.now();Dn&&n-Dn<st&&(Xe=!0),I.m=!0}if(t==="v"){const n=Date.now();zn&&n-zn<st&&(je=!0),I.v=!0}if(t==="n"){const n=Date.now();Hn&&n-Hn<st&&(Ye=!0),I.n=!0}if(t==="arrowleft"){const n=Date.now();dn&&n-Ts<st&&(Qe=!0),I.arrowleft=!0}if(t==="arrowright"){const n=Date.now();dn&&n-dn<st&&(Ze=!0),I.arrowright=!0}else I[t]=!0});window.addEventListener("keyup",e=>{if(F=="select")return;const t=e.key.toLowerCase();t==="q"&&(Ln=Date.now(),Ue=!1,I.q=!1),t==="d"&&(Rn=Date.now(),Ve=!1,I.d=!1),t==="k"&&(In=Date.now(),Ke=!1,I.k=!1),t==="m"&&(Dn=Date.now(),Xe=!1,I.m=!1),t==="v"&&(zn=Date.now(),je=!1,I.v=!1),t==="n"&&(Hn=Date.now(),Ye=!1,I.n=!1),t==="arrowleft"&&(Ts=Date.now(),Qe=!1,I.arrowleft=!1),t==="arrowright"?(dn=Date.now(),Ze=!1,I.arrowright=!1):I[t]=!1});var wt=["run","run","run","run"];function ot(e,t,n,o,s,i,a,l,r,c,f){const u=200*W,p=.7*W,m=p*1.5;if(ce[r-1]>=ie&&wt[r-1]!="ghost"){dt.push({name:"Player "+r,rank:dt.length+1}),wt[r-1]="ghost";return}if(wt[r-1]=="run"){let h=new L;n.getWorldDirection(h),h.y=0,h.normalize(),he("boostTrap",e)&&(r==1&&(Ht=Me,pt=!0),r==2&&(kt=Me,mt=!0),r==3&&(Ct=Me,ht=!0),r==4&&(Ot=Me,gt=!0));let T=new L(0,0,0);if(o){N=="load"&&(r==1&&(Pt+=E),r==2&&(Ft+=E),r==3&&(Bt+=E),r==4&&(Nt+=E),c>3&&c<f&&(ea(e),r==1&&(Pt<=2?lt+=E/2:lt=0,Ht=Me,pt=!0),r==2&&(Ft<=2?ct+=E/2:ct=0,kt=Me,mt=!0),r==3&&(Bt<=2?ut+=E/2:ut=0,Ct=Me,ht=!0),r==4&&(Nt<=2?ft+=E/2:ft=0,Ot=Me,gt=!0)));let y=u*En(e);y*=1+(r==1?lt:r==2?ct:r==3?ut:ft),T.add(h.clone().multiplyScalar(y*l*40))}else N=="load"&&(r==1&&(Pt=0,lt=0,Ht=0,pt=!1),r==2&&(Ft=0,ct=0,kt=0,mt=!1),r==3&&(Bt=0,ut=0,Ct=0,ht=!1),r==4&&(Nt=0,ft=0,Ot=0,gt=!1));if(s){let y=u*En(e);y*=1+(r==1?lt:r==2?ct:r==3?ut:ft),T.add(h.clone().multiplyScalar(-y*l*40))}N=="run"&&(t.velocity.x=T.x,t.velocity.z=T.z),(o||s||i||a)&&t.wakeUp(),N=="run"&&i?r==1&&Ue||r==2&&Ke||r==3&&je||r==4&&Qe?(t.angularVelocity.y=m,Cs(e,"left",r)):t.angularVelocity.y=p:N=="run"&&a?r==1&&Ve||r==2&&Xe||r==3&&Ye||r==4&&Ze?(t.angularVelocity.y=-m,Cs(e,"right",r)):t.angularVelocity.y=-p:t.angularVelocity.y*=.9}else if(wt[r-1]=="ghost"){const h=new L(0,0,1).applyQuaternion(e.quaternion).setY(0).normalize(),T=200,y=new L(-h.z,0,h.x).normalize(),g=y.clone().negate();let D=h.clone();const k=Zn(e,h,T,10),we=T/10;if(k<.7*we){const xe=Zn(e,y,T,10),Te=Zn(e,g,T,10);xe>Te?D.add(y.clone().multiplyScalar(.5)):D.add(g.clone().multiplyScalar(.5))}else{const xe=e.position.clone().add(y.clone().multiplyScalar(T)),Te=e.position.clone().add(g.clone().multiplyScalar(T));he("road",{position:xe})||D.add(g.clone().multiplyScalar(.1)),he("road",{position:Te})||D.add(y.clone().multiplyScalar(.1))}const _=Gi(e,T);if(_){const xe=_.mesh.position.clone().sub(e.position).setY(0);h.dot(xe.normalize())>.9?y.dot(xe)>0?D.add(g.clone().multiplyScalar(.4)):D.add(y.clone().multiplyScalar(.4)):D.sub(xe.normalize().multiplyScalar(.8))}D.normalize();let X=h.angleTo(D);const He=new L().crossVectors(h,D).y>=0?1:-1;let Fe=.3;k<.7*we&&(Fe=.5);let wn=He*Fe*W*X;const bt=.01;t.angularVelocity.y=$.lerp(t.angularVelocity.y,wn,bt),t.angularVelocity.y=$.lerp(t.angularVelocity.y,wn,bt);let tt=1;const me=50*W*En(e)*tt;t.velocity.x=D.x*me,t.velocity.z=D.z*me}}function Gi(e,t){const n=new L(0,0,-1).applyQuaternion(e.quaternion).setY(0).normalize(),o=e.position.clone();for(let s of St){const i=s.mesh.position.clone().sub(o);if(i.length()<t&&n.dot(i.normalize())>.7)return s}return null}function Zn(e,t,n=150,o=10){let s=0;const i=Math.floor(n/o);for(let a=1;a<=i;a++){const l=a*o,r=e.position.clone().add(t.clone().multiplyScalar(l));he("road",{position:r})&&s++}return s}function qi(e){if(N=="load")return;const t=e;Ve||Ue?(nn+=t,!Lt&&nn>=1&&(Lt=!0,Ht=Me)):(nn=0,Lt?(sn=!0,Lt=!1):(sn=!1,Lt=!1)),sn||pt?(Ht-=t,sn=!1,pt=!0,Ht<=0&&(pt=!1,nn=0),Pt==0&&(lt=1)):(lt*=.9,Pt!=0&&(Pt=0,pt=!1)),Xe||Ke?(on+=t,!Rt&&on>=1&&(Rt=!0,kt=Me)):(on=0,Rt?(an=!0,Rt=!1):(an=!1,Rt=!1)),an||mt?(kt-=t,an=!1,mt=!0,kt<=0&&(mt=!1,on=0),Ft==0&&(ct=1)):(ct*=.9,Ft!=0&&(Ft=0,mt=!1)),Ye||je?(rn+=t,!It&&rn>=1&&(It=!0,Ct=Me)):(rn=0,It?(ln=!0,It=!1):(ln=!1,It=!1)),ln||ht?(Ct-=t,ln=!1,ht=!0,Ct<=0&&(ht=!1,rn=0),Bt==0&&(ut=1)):(ut*=.9,Bt!=0&&(Bt=0,ht=!1)),Ze||Qe?(cn+=t,!Dt&&cn>=1&&(Dt=!0,Ot=Me)):(cn=0,Dt?(un=!0,Dt=!1):(un=!1,Dt=!1)),un||gt?(Ot-=t,un=!1,gt=!0,Ot<=0&&(gt=!1,cn=0),Nt==0&&(ft=1)):(ft*=.9,Nt!=0&&(Nt=0,gt=!1))}function Wi(e){const t=document.createElement("div");t.id="scoreTableContainer",t.style.width="70vw",t.style.height="70vh",t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -60%)",t.style.backgroundColor="rgba(255, 255, 255, 0.5)",t.style.border="2px solid rgba(0, 0, 0, 1)",t.style.boxShadow="0 0 20px rgba(0, 0, 0, 0.5)",t.style.borderRadius="10px",t.style.overflow="auto",t.style.opacity="0",t.style.transition="opacity 5s";const n=document.createElement("table");n.style.width="100%",n.style.height="100%",n.style.borderCollapse="collapse";const o=document.createElement("tr"),s=document.createElement("th");s.textContent="Rank",s.style.width="10%",s.style.border="1px solid rgba(0, 0, 0, 1)",s.style.padding="10px",s.style.textAlign="center";const i=document.createElement("th");i.textContent="Players",i.style.width="90%",i.style.border="1px solid rgba(0, 0, 0, 1)",i.style.padding="10px",i.style.textAlign="center",o.appendChild(s),o.appendChild(i),n.appendChild(o),e.forEach(a=>{const l=document.createElement("tr"),r=document.createElement("td");r.textContent=a.rank,r.style.width="10%",r.style.border="1px solid rgba(0, 0, 0, 1)",r.style.padding="10px",r.style.textAlign="center";const c=document.createElement("td");c.textContent=a.name,c.style.width="90%",c.style.border="1px solid rgba(0, 0, 0, 1)",c.style.padding="10px",c.style.textAlign="center",l.appendChild(r),l.appendChild(c),n.appendChild(l)}),t.appendChild(n),document.body.appendChild(t),setTimeout(()=>{t.style.opacity="1"},50)}function Ms(){const e=document.getElementById("scoreTableContainer");e&&e.parentNode.removeChild(e)}function Ui(){const e=window.innerWidth*.012;document.querySelectorAll("#scoreTableContainer td, #scoreTableContainer th").forEach(n=>{n.style.fontSize=e+"px"})}Ms();function Vi(){const e=document.createElement("img");e.src="Image/ok_unselect.png",e.id="okButton",e.style.position="fixed",e.style.bottom="5%",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.cursor="pointer",e.style.width="30vw",e.style.height="auto",e.style.opacity="0",e.style.transition="opacity 5s",e.addEventListener("mouseover",()=>{e.src="Image/ok_select.png"}),e.addEventListener("mouseout",()=>{e.src="Image/ok_unselect.png"}),e.addEventListener("click",()=>{Ms(),Zs()}),document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1"},50)}function Ki(){const e=document.getElementById("okButton");e&&e.parentNode.removeChild(e)}function Xi(){const e=navigator.getGamepads()[ge];e&&e.buttons[0].pressed&&(Ms(),Zs())}function Zs(){const e=document.createElement("video");e.src="Video/final.mp4",e.autoplay=!0,e.playsInline=!0,e.controls=!1,e.loop=!1,e.volume=.4,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.zIndex="10000",document.body.appendChild(e),e.addEventListener("ended",()=>{F="select",e.parentNode.removeChild(e)})}function Pe(e,t,n,o=1){if(wt[o-1]=="run"){const a=new L(0,32,-48).clone().applyQuaternion(e.quaternion),l=new L().copy(e.position).add(a);t.position.lerp(l,.1*n),t.lookAt(e.position)}else{var s=new L(0,32,-48);if(!ye[o-1])ye[o-1]=E;else if(ye[o-1]>5){ye[o-1]+=E;let r=ye[o-1]*10-5<96?ye[o-1]*10-5:96,c=ye[o-1]*10-5<96?ye[o-1]*3-5:ye[o-1]*10+5<192?25.25*2-(ye[o-1]*3-5):0;var s=new L(c,32,-48+r)}else ye[o-1]<=5&&(ye[o-1]+=E);const i=s.clone().applyQuaternion(e.quaternion),a=new L().copy(e.position).add(i);t.position.lerp(a,.1*n),t.lookAt(e.position);let l=!0;for(let r=0;r<oe;r++)if(wt[r]==="run"){l=!1;break}l&&(at||(at=E),at+=E,at>5&&at<6&&(Wi(dt),Vi(),at=6),at>7&&Xi())}}let kn=[],pn=[];const ji=200;function Js(e){let t;if(kn.length>0)t=kn.pop(),t.material.color.setHex(e),t.material.opacity=1,t.userData.lifetime=0;else{const n=new ps(.3,8,8),o=new q({color:e,transparent:!0,opacity:1,blending:jo,depthWrite:!1});t=new _e(n,o),t.userData={lifetime:0}}return t}function Yi(e){e.material.opacity=1,e.userData.lifetime=0,e.position.set(0,-1e3,0),kn.length<ji?kn.push(e):(e.geometry.dispose(),e.material.dispose())}function Cs(e,t,n){const o=new L;t==="left"?o.set(1,0,-3):o.set(-1,0,-3),o.applyQuaternion(e.quaternion),o.x+=(Math.random()-.5)*2,o.y+=(Math.random()-.5)*2,o.z+=(Math.random()-.5)*2;const s=new L().copy(e.position).add(o),i=(n==1?Lt:n==2?Rt:n==3?It:Dt)?16746496:43775,a=Js(i);a.position.copy(s),a.material.color.setHex(i),a.material.opacity=1,a.userData.lifetime=0,M.add(a),pn.push(a)}function Qi(e){for(let t=pn.length-1;t>=0;t--){const n=pn[t];n.userData.lifetime+=e,n.material.opacity=Math.max(0,1-n.userData.lifetime*5),n.userData.lifetime>.2&&(M.remove(n),pn.splice(t,1),Yi(n))}}let Cn=[];const Zi=100;function Ji(){if(Cn.length>0)return Cn.pop();const e=new ps(1,8,8),t=new q({color:16711680,transparent:!0,opacity:.8});return new _e(e,t)}function $i(e){e.material.opacity=.8,e.position.set(0,-1e3,0),Cn.length<Zi?Cn.push(e):(e.geometry.dispose(),e.material.dispose())}function ea(e){const t=Ji(),n=new L(Math.random()>=.5?-5:5,Math.random()*6-1,Math.random()*-4-15);n.applyQuaternion(e.quaternion),t.position.copy(e.position).add(n),M.add(t),setTimeout(()=>{M.remove(t),$i(t)},200)}const St=[];function z(e,t,n,o,s,i,a,l=!1){const r=new Yt(e,t,n),c=new q({color:16711887,wireframe:!0}),f=new _e(r,c);f.position.set(o,s,i),f.visible=l,M.add(f);const u=new Zt(new pe(e/2,t/2,n/2)),p=new $e({shape:u,position:new pe(o,s,i)});return a?p.mass=200:p.type=$e.STATIC,le.addBody(p),St.push({mesh:f,body:p}),{mesh:f,body:p}}z(30,60,4e3,-2300,-20,-250,!0);z(4600,60,30,0,-20,1750,!0);z(4600,60,30,0,-20,-2230,!0);z(30,60,4e3,2260,-20,-250,!0);let yn=0,Et={x:null,z:null};function ta(e){let t=e.trim().split(/\s+/);if(t[0].toLowerCase()==="c"){if(yn===0){if(t.length<3){console.log("Erreur: veuillez fournir deux coordonn\xE9es, par ex: c 100 200");return}let n=parseFloat(t[1]),o=parseFloat(t[2]);if(isNaN(n)||isNaN(o)){console.log("Erreur: les valeurs x et z doivent \xEAtre des nombres.");return}Et.x=n,Et.z=o,yn=1}else if(yn===1){if(t.length<3){console.log("Erreur: veuillez fournir deux coordonn\xE9es, par ex: c 300 400");return}let n=parseFloat(t[1]),o=parseFloat(t[2]);if(isNaN(n)||isNaN(o)){console.log("Erreur: les valeurs x et z doivent \xEAtre des nombres.");return}let s=Math.abs(n-Et.x),i=Math.abs(o-Et.z),a=(Et.x+n)/2,l=(Et.z+o)/2;z(s,60,i,a,-20,l,!0,!0),console.log("createCube("+s+", 60,"+i+","+a+",-20,"+l+" , true, true);"),yn=0,Et={x:null,z:null}}}}z(85,60,309,-1207.5,-20,1023.5,!0);z(40,60,40,-2138,-20,-580,!0);z(40,60,40,-1708,-20,-580,!0);z(40,60,2505,-1500,-20,-342,!0);z(80,60,235,-1550,-20,-1324,!0);z(80,60,235,-1550,-20,-938,!0);z(80,60,235,-1550,-20,-552,!0);z(80,60,235,-1550,-20,-171,!0);z(80,60,235,-1550,-20,215,!0);z(80,60,235,-1550,-20,600,!0);z(715,60,40,-1135,-20,895,!0);z(1650,60,40,5,-20,700,!0);z(620,60,350,1105,-20,775,!0);z(513,60,685,-1.5,-20,-1915,!0);z(2050,60,40,-195,-20,620,!0);z(40,60,190,-802.5,-20,795,!0);z(80,60,150,60,-20,1235,!0);z(80,60,375,60,-20,1572,!0);z(465,60,1624,-1282.5,-20,-782,!0);z(60,60,660,-1195,-20,310,!0);z(880,60,238,-640,-20,-668,!0);z(1065,60,125,267.5,-20,-725,!0);z(315,60,118,800,-20,-802.5,!0);z(510,60,705,1237,-20,-1167,!0);z(245,60,202,875,-20,-915,!0);z(945,60,275,1797.5,-20,-205,!0);z(810,60,168,923,-20,-152,!0);z(855,60,125,253,-20,-16,!0);let $s=window.innerWidth/2,eo=window.innerHeight/2;document.addEventListener("mousemove",e=>{$s=e.clientX,eo=e.clientY});const ne={z:!1,s:!1,q:!1,d:!1,space:!1,shiftSpace:!1};window.addEventListener("keydown",e=>{const t=e.key.toLowerCase();t==="z"&&(ne.z=!0),t==="s"&&(ne.s=!0),t==="q"&&(ne.q=!0),t==="d"&&(ne.d=!0),e.key===" "&&(e.shiftKey?ne.shiftSpace=!0:ne.space=!0)});window.addEventListener("keyup",e=>{const t=e.key.toLowerCase();t==="z"&&(ne.z=!1),t==="s"&&(ne.s=!1),t==="q"&&(ne.q=!1),t==="d"&&(ne.d=!1),e.key===" "&&(ne.space=!1,ne.shiftSpace=!1)});function na(e){const t=document.getElementById("vehicleCoordinates");t&&(t.innerHTML=`x: ${R.position.x.toFixed(2)}<br>
                           y: ${R.position.y.toFixed(2)}<br>
                           z: ${R.position.z.toFixed(2)}`);const n=.005,o=5e3,s=window.innerWidth/2,i=window.innerHeight/2,a=($s-s)*n,l=(eo-i)*n,r=Math.max(-Math.PI/2,Math.min(Math.PI/2,l));R.rotation.set(-r,-a,0),ne.z&&(R.position.z-=o*e),ne.s&&(R.position.z+=o*e),ne.q&&(R.position.x-=o*e),ne.d&&(R.position.x+=o*e),ne.space&&(R.position.y+=o*e),ne.shiftSpace&&(R.position.y-=o*e)}function sa(){const e=document.getElementById("vehicleCoordinates");e&&(e.innerHTML=`x: ${A.position.x.toFixed(2)}<br>
                           y: ${A.position.y.toFixed(2)}<br>
                           z: ${A.position.z.toFixed(2)}`)}const re=[];function oa(){let e=os;os="",(e==="runsolo"||e==="run")&&(F="runsolo",console.log("Commande:",e)),e==="stop"&&(F="stop",console.log("Commande:",e)),e==="rundev"&&(F="rundev",console.log("Commande:",e)),e==="runsplit"&&(F="runsplit",console.log("Commande:",e)),e==="runsplit3"&&(F="runsplit3",console.log("Commande:",e)),e==="runsplit4"&&(F="runsplit4",console.log("Commande:",e)),e==="select"&&(F="select",console.log("Commande:",e)),e==="50cc"&&(W=1,console.log("Commande:",e)),e==="150cc"&&(W=2,console.log("Commande:",e)),e==="100cc"&&(W=1.5,console.log("Commande:",e)),e==="200cc"&&(W=2.5,console.log("Commande:",e)),e==="p0"&&(Se=0),e==="p1"&&(Se=1),e==="p2"&&(Se=2),e==="p3"&&(Se=3),e.trim().toLowerCase().startsWith("c")&&ta(e)}let d=null;function ia(){if(le.step(E),N=="start"){Wn(O[0]),G&&(G.visible=!1),K&&(K.visible=!1),j&&(j.visible=!1),S.position.x=b[11].x,S.position.z=b[11].z,A.position.x=b[11].x,A.position.z=b[11].z,x=0,be=5;for(let e=0;e<11;e++){const t=vt[Math.floor(Math.random()*vt.length)],n={x:b[e].x,y:-22,z:b[e].z},o=Nn.includes(t)?1:100;re.push(Un(t,n,o))}N="load"}if(Kn(x,be,1),N==="load"&&(x+=E,console.log(x),x<.5&&(d||(d=document.createElement("img"),d.id="countdownImg",d.style.position="fixed",d.style.top="30%",d.style.left="50%",d.style.transform="translate(-50%, -50%)",d.style.height="30vh",d.style.opacity="0.7",d.style.transition="opacity 1s ease-out",document.body.appendChild(d),console.log("IMG cr\xE9\xE9e"))),A.velocity.set(0,0,0),A.angularVelocity.set(0,0,0),x>=be&&(N="run")),d)if(x>5){d.src="Image/decompte_0.png";let e=1-(x-5);x+=E,d.style.opacity=e,e<0&&(d&&(d.parentNode.removeChild(d),d=null),e=0)}else x>4?(d.src="Image/decompte_1.png",d.style.opacity="0.7"):x>3?(d.src="Image/decompte_2.png",d.style.opacity="0.7"):x>2&&(d.src="Image/decompte_3.png",d.style.opacity="0.7");if(S.position.copy(A.position),S.quaternion.copy(A.quaternion),ae){const e=new L(0,O[0]==1?-5:0,-5);e.applyQuaternion(S.quaternion),ae.position.copy(S.position).add(e),ae.quaternion.copy(S.quaternion)}Ee.position.copy(Ae.position),Ee.quaternion.copy(Ae.quaternion),St.forEach(e=>{e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion)}),Oe(S),Pe(S,R,W,1),re.forEach(e=>{Vn(e,E)})}function aa(){if(le.step(E),N=="start"){Wn(O[0]),xs(O[1]),G&&(G.visible=!0),K&&(K.visible=!1),j&&(j.visible=!1),S.position.x=b[11].x,S.position.z=b[11].z,A.position.x=b[11].x,A.position.z=b[11].z,x=0,be=5;for(let e=0;e<10;e++){const t=vt[Math.floor(Math.random()*vt.length)],n={x:b[e].x,y:-22,z:b[e].z},o=Nn.includes(t)?1:100;re.push(Un(t,n,o))}N="load"}if(Kn(x,be,2),N=="load"&&(x+=E,console.log(x),x>=be&&(N="run"),x<.5&&(d||(d=document.createElement("img"),d.id="countdownImg",d.style.position="fixed",d.style.top="40%",d.style.left="50%",d.style.transform="translate(-50%, -50%)",d.style.height="30vh",d.style.opacity="0.7",d.style.transition="opacity 1s ease-out",document.body.appendChild(d),console.log("IMG cr\xE9\xE9e"))),A.velocity.set(0,0,0),A.angularVelocity.set(0,0,0),V.velocity.set(0,0,0),V.angularVelocity.set(0,0,0)),d)if(x>5){d.src="Image/decompte_0.png";let e=1-(x-5);x+=E,d.style.opacity=e,e<0&&(d&&(d.parentNode.removeChild(d),d=null),e=0)}else x>4?(d.src="Image/decompte_1.png",d.style.opacity="0.7"):x>3?(d.src="Image/decompte_2.png",d.style.opacity="0.7"):x>2&&(d.src="Image/decompte_3.png",d.style.opacity="0.7");if(S.position.copy(A.position),S.quaternion.copy(A.quaternion),B.position.copy(V.position),B.quaternion.copy(V.quaternion),ae){const e=new L(0,O[0]==1?-5:0,-5);e.applyQuaternion(S.quaternion),ae.position.copy(S.position).add(e),ae.quaternion.copy(S.quaternion)}if(G){const e=new L(0,O[1]==1?-5:0,-5);e.applyQuaternion(B.quaternion),G.position.copy(B.position).add(e),G.quaternion.copy(B.quaternion)}Ee.position.copy(Ae.position),Ee.quaternion.copy(Ae.quaternion),St.forEach(e=>{e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion)}),Oe(S),Oe(B),Pe(S,R,W,1),Pe(B,ue,W,2),re.forEach(e=>{Vn(e,E)})}function ra(){if(le.step(E),N=="start"){Wn(O[0]),xs(O[1]),Qs(O[2]),G&&(G.visible=!0),K&&(K.visible=!0),j&&(j.visible=!1),S.position.x=b[11].x,S.position.z=b[11].z,A.position.x=b[11].x,A.position.z=b[11].z,x=0,be=5;for(let e=0;e<9;e++){const t=vt[Math.floor(Math.random()*vt.length)],n={x:b[e].x,y:-22,z:b[e].z},o=Nn.includes(t)?1:100;re.push(Un(t,n,o))}N="load"}if(Kn(x,be,3),N=="load"&&(x+=E,console.log(x),x>=be&&(N="run"),x<.5&&(d||(d=document.createElement("img"),d.id="countdownImg",d.style.position="fixed",d.style.top="50%",d.style.left="50%",d.style.transform="translate(-50%, -50%)",d.style.height="30vh",d.style.opacity="0.7",d.style.transition="opacity 1s ease-out",document.body.appendChild(d),console.log("IMG cr\xE9\xE9e"))),A.velocity.set(0,0,0),A.angularVelocity.set(0,0,0),V.velocity.set(0,0,0),V.angularVelocity.set(0,0,0),ee.velocity.set(0,0,0),ee.angularVelocity.set(0,0,0)),d)if(x>5){d.src="Image/decompte_0.png";let e=1-(x-5);x+=E,d.style.opacity=e,e<0&&(d&&(d.parentNode.removeChild(d),d=null),e=0)}else x>4?(d.src="Image/decompte_1.png",d.style.opacity="0.7"):x>3?(d.src="Image/decompte_2.png",d.style.opacity="0.7"):x>2&&(d.src="Image/decompte_3.png",d.style.opacity="0.7");if(S.position.copy(A.position),S.quaternion.copy(A.quaternion),B.position.copy(V.position),B.quaternion.copy(V.quaternion),J.position.copy(ee.position),J.quaternion.copy(ee.quaternion),ae){const e=new L(0,O[0]==1?-5:0,-5);e.applyQuaternion(S.quaternion),ae.position.copy(S.position).add(e),ae.quaternion.copy(S.quaternion)}if(G){const e=new L(0,O[1]==1?-5:0,-5);e.applyQuaternion(B.quaternion),G.position.copy(B.position).add(e),G.quaternion.copy(B.quaternion)}if(K){const e=new L(0,O[2]==1?-5:0,-5);e.applyQuaternion(J.quaternion),K.position.copy(J.position).add(e),K.quaternion.copy(J.quaternion)}Ee.position.copy(Ae.position),Ee.quaternion.copy(Ae.quaternion),St.forEach(e=>{e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion)}),Oe(S),Oe(B),Oe(J),Pe(S,R,W,1),Pe(B,ue,W,2),Pe(J,Ie,W,3),re.forEach(e=>{Vn(e,E)})}function la(){if(le.step(E),N=="start"){Wn(O[0]),xs(O[1]),Qs(O[2]),Bi(O[3]),G&&(G.visible=!0),K&&(K.visible=!0),j&&(j.visible=!0),S.position.x=b[11].x,S.position.z=b[11].z,A.position.x=b[11].x,A.position.z=b[11].z,x=0,be=5;for(let e=0;e<8;e++){const t=vt[Math.floor(Math.random()*vt.length)],n={x:b[e].x,y:-22,z:b[e].z},o=Nn.includes(t)?1:100;re.push(Un(t,n,o))}N="load"}if(Kn(x,be,4),N=="load"&&(x+=E,console.log(x),x>=be&&(N="run"),x<.5&&(d||(d=document.createElement("img"),d.id="countdownImg",d.style.position="fixed",d.style.top="50%",d.style.left="50%",d.style.transform="translate(-50%, -50%)",d.style.height="30vh",d.style.opacity="0.7",d.style.transition="opacity 1s ease-out",document.body.appendChild(d),console.log("IMG cr\xE9\xE9e"))),A.velocity.set(0,0,0),A.angularVelocity.set(0,0,0),V.velocity.set(0,0,0),V.angularVelocity.set(0,0,0),ee.velocity.set(0,0,0),ee.angularVelocity.set(0,0,0),fe.velocity.set(0,0,0),fe.angularVelocity.set(0,0,0)),d)if(x>5){d.src="Image/decompte_0.png";let e=1-(x-5);x+=E,d.style.opacity=e,e<0&&(d&&(d.parentNode.removeChild(d),d=null),e=0)}else x>4?(d.src="Image/decompte_1.png",d.style.opacity="0.7"):x>3?(d.src="Image/decompte_2.png",d.style.opacity="0.7"):x>2&&(d.src="Image/decompte_3.png",d.style.opacity="0.7");if(S.position.copy(A.position),S.quaternion.copy(A.quaternion),B.position.copy(V.position),B.quaternion.copy(V.quaternion),J.position.copy(ee.position),J.quaternion.copy(ee.quaternion),ve.position.copy(fe.position),ve.quaternion.copy(fe.quaternion),ae){const e=new L(0,O[0]==1?-5:0,-5);e.applyQuaternion(S.quaternion),ae.position.copy(S.position).add(e),ae.quaternion.copy(S.quaternion)}if(G){const e=new L(0,O[1]==1?-5:0,-5);e.applyQuaternion(B.quaternion),G.position.copy(B.position).add(e),G.quaternion.copy(B.quaternion)}if(K){const e=new L(0,O[2]==1?-5:0,-5);e.applyQuaternion(J.quaternion),K.position.copy(J.position).add(e),K.quaternion.copy(J.quaternion)}if(j){const e=new L(0,O[3]==1?-5:0,-5);e.applyQuaternion(ve.quaternion),j.position.copy(ve.position).add(e),j.quaternion.copy(ve.quaternion)}Ee.position.copy(Ae.position),Ee.quaternion.copy(Ae.quaternion),St.forEach(e=>{e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion)}),Oe(S),Oe(B),Oe(J),Oe(ve),Pe(S,R,W,1),Pe(B,ue,W,2),Pe(J,Ie,W,3),Pe(ve,zt,W,4),re.forEach(e=>{Vn(e,E)})}function ca(){le.step(E);const e=io.getDelta();na(e),Ee.position.copy(Ae.position),Ee.quaternion.copy(Ae.quaternion),St.forEach(t=>{t.mesh.position.copy(t.body.position),t.mesh.quaternion.copy(t.body.quaternion)})}function ua(){const e=ws.attributes.position;for(let t=0;t<e.count;t++){let n=e.getX(t);n+=.5,n>rt/2&&(n=-rt/2),e.setX(t,n)}e.needsUpdate=!0}function fa(e){if(_n(U),_n(Y),_n(Q),_n(Z),Ne){qe+=e;let t=qe/da;t>=1&&(t=1,Ne=!1);const n=pa(t);v.position.x=$.lerp(Ge.x,ke.x,n),v.position.y=$.lerp(Ge.y,ke.y,n)}C.children.forEach(t=>{if(t.isMesh&&t.userData&&t.userData.name==="retour")if(v.position.x==0&&v.position.y==0)t.visible=!1;else{t.visible=!0;const n=t.userData,{ratioW:o,ratioH:s}=Wt(),i=hn[n.index].x*o,a=hn[n.index].y*s;t.position.set(i+v.position.x,a+v.position.y,t.position.z)}})}let U;Le.load("3D_Model/mario_arma.glb",e=>{U=e.scene,U.name="perso",U.spec=1;const t=5;U.userData.refPos={x:980,y:.9*551},U.userData.refScale=t;const{ratioW:n,ratioH:o}=Wt(),s=Math.min(n,o),i=U.userData.refPos.x*n,a=U.userData.refPos.y*o;U.position.set(i,a,0),U.scale.set(t*s,t*s,t*s),U.rotation.x=Math.PI/10,U.traverse(r=>{if(r.isMesh){r.frustumCulled=!1;const c=r.material;let f=c.map||null;r.material=new q({map:f,color:c.color||16777215,side:ze})}}),C.add(U),De[0]=U;const l=Jt();l.name="selection_label"+0,U.spec==1?l.position.set(0,20,0):U.spec==2&&(l.position.set(0,.2,0),l.scale.set(.2,.05,.1)),U.add(l)});let Y;Le.load("3D_Model/car_5.glb",e=>{Y=e.scene,Y.name="perso",Y.spec=2;const t=100;Y.userData.refPos={x:1180,y:.9*551},Y.userData.refScale=t;const{ratioW:n,ratioH:o}=Wt(),s=Math.min(n,o),i=Y.userData.refPos.x*n,a=Y.userData.refPos.y*o;Y.position.set(i,a,0),Y.scale.set(t*s,t*s,t*s),Y.rotation.x=Math.PI/10,Y.traverse(l=>{if(l.isMesh){l.frustumCulled=!1;const r=l.material;let c=r.map||null;l.material=new q({map:c,color:r.color||16777215,side:ze})}}),C.add(Y)});let Q;Le.load("3D_Model/voiture_1.glb",e=>{Q=e.scene,Q.name="perso",Q.spec=3;const t=100;Q.userData.refPos={x:1380,y:.9*551},Q.userData.refScale=t;const{ratioW:n,ratioH:o}=Wt(),s=Math.min(n,o),i=Q.userData.refPos.x*n,a=Q.userData.refPos.y*o;Q.position.set(i,a,0),Q.scale.set(t*s,t*s,t*s),Q.rotation.x=Math.PI/10,Q.traverse(l=>{if(l.isMesh){l.frustumCulled=!1;const r=l.material;let c=r.map||null;l.material=new q({map:c,color:r.color||16777215,side:ze})}}),C.add(Q)});let Z;Le.load("3D_Model/voiture_2.glb",e=>{Z=e.scene,Z.name="perso",Z.spec=4;const t=100;Z.userData.refPos={x:1580,y:.9*551},Z.userData.refScale=t;const{ratioW:n,ratioH:o}=Wt(),s=Math.min(n,o),i=Z.userData.refPos.x*n,a=Z.userData.refPos.y*o;Z.position.set(i,a,0),Z.scale.set(t*s,t*s,t*s),Z.rotation.x=Math.PI/10,Z.traverse(l=>{if(l.isMesh){l.frustumCulled=!1;const r=l.material;let c=r.map||null;l.material=new q({map:c,color:r.color||16777215,side:ze})}}),C.add(Z)});function _n(e){e&&(e.rotation.y+=.02)}var Se=0,oe=1;const hn=[{name:"home",image:"Image/mario.png",fitByHeight:!0,x:349,y:0,z:0,selection:!1},{name:"solo",image:"Image/solo_unselect.png",image_select:"Image/solo_select.png",fitByHeight:!1,size:.5,x:-300,y:150,z:0,selection:!0},{name:"multi",image:"Image/multi_unselect.png",image_select:"Image/multi_select.png",fitByHeight:!1,size:.5,x:-300,y:0,z:0,selection:!0},{name:"config",image:"Image/config_unselect.png",image_select:"Image/config_select.png",fitByHeight:!1,size:.5,x:-300,y:-150,z:0,selection:!0},{name:"50cc",image:"Image/50cc_unselect.png",image_select:"Image/50cc_select.png",fitByHeight:!1,size:.5,x:0,y:160+551,z:0,selection:!0},{name:"100cc",image:"Image/100cc_unselect.png",image_select:"Image/100cc_select.png",fitByHeight:!1,size:.5,x:0,y:40+551,z:0,selection:!0},{name:"150cc",image:"Image/150cc_unselect.png",image_select:"Image/150cc_select.png",fitByHeight:!1,size:.5,x:0,y:-80+551,z:0,selection:!0},{name:"200cc",image:"Image/200cc_unselect.png",image_select:"Image/200cc_select.png",fitByHeight:!1,size:.5,x:0,y:-200+551,z:0,selection:!0},{name:"50cc",image:"Image/50cc_unselect.png",image_select:"Image/50cc_select.png",fitByHeight:!1,size:.5,x:0,y:160-551,z:0,selection:!0},{name:"100cc",image:"Image/100cc_unselect.png",image_select:"Image/100cc_select.png",fitByHeight:!1,size:.5,x:0,y:40-551,z:0,selection:!0},{name:"150cc",image:"Image/150cc_unselect.png",image_select:"Image/150cc_select.png",fitByHeight:!1,size:.5,x:0,y:-80-551,z:0,selection:!0},{name:"200cc",image:"Image/200cc_unselect.png",image_select:"Image/200cc_select.png",fitByHeight:!1,size:.5,x:0,y:-200-551,z:0,selection:!0},{name:"retour",image:"Image/retour_unselect.png",image_select:"Image/retour_select.png",fitByHeight:!1,size:.3,x:-575,y:-252,z:0,selection:!0},{name:"ok_solo_kart",image:"Image/ok_unselect.png",image_select:"Image/ok_select.png",fitByHeight:!1,size:.5,x:1280,y:351,z:0,selection:!0},{name:"ok_solo_tour",image:"Image/ok_unselect.png",image_select:"Image/ok_select.png",fitByHeight:!1,size:.5,x:2560,y:351,z:0,selection:!0},{name:"tour_1",image:"Image/tour_1.png",fitByHeight:!1,size:.2,x:2200,y:551,z:0,selection:!0},{name:"tour_2",image:"Image/tour_2.png",fitByHeight:!1,size:.2,x:2560,y:551,z:0,selection:!0},{name:"tour_3",image:"Image/tour_3.png",fitByHeight:!1,size:.2,x:2920,y:551,z:0,selection:!0},{name:"player_1",image:"Image/joueur1_unselect.png",image_select:"Image/joueur1_select.png",fitByHeight:!1,size:.3,x:705,y:-152+651,z:0,selection:!0},{name:"player_2",image:"Image/joueur2_unselect.png",image_select:"Image/joueur2_select.png",fitByHeight:!1,size:.3,x:705,y:-102+651,z:0,selection:!0},{name:"player_3",image:"Image/joueur3_unselect.png",image_select:"Image/joueur3_select.png",fitByHeight:!1,size:.3,x:705,y:-52+651,z:0,selection:!0},{name:"player_4",image:"Image/joueur4_unselect.png",image_select:"Image/joueur4_select.png",fitByHeight:!1,size:.3,x:705,y:-2+651,z:0,selection:!0},{name:"2p",image:"Image/2p_unselect.png",image_select:"Image/2p_select.png",fitByHeight:!1,size:.5,x:1280,y:-450,z:0,selection:!0},{name:"3p",image:"Image/3p_unselect.png",image_select:"Image/3p_select.png",fitByHeight:!1,size:.5,x:1280,y:-570,z:0,selection:!0},{name:"4p",image:"Image/4p_unselect.png",image_select:"Image/4p_select.png",fitByHeight:!1,size:.5,x:1280,y:-690,z:0,selection:!0},{name:"mannette_1",image:"Image/pro_control_upscaled.png",fitByHeight:!1,size:.2,x:-200,y:1202,z:0,selection:!1},{name:"mannette_2",image:"Image/pro_control_upscaled.png",fitByHeight:!1,size:.2,x:200,y:1202,z:0,selection:!1},{name:"mannette_3",image:"Image/pro_control_upscaled.png",fitByHeight:!1,size:.2,x:-200,y:1002,z:0,selection:!1},{name:"mannette_4",image:"Image/pro_control_upscaled.png",fitByHeight:!1,size:.2,x:200,y:1002,z:0,selection:!1}];let Ce=null,Ne=!1,Ge=new L,ke=new L;const da=1;let qe=0;function pa(e){return e<.5?2*e*e:-1+(4-2*e)*e}const jt=new Qt,Je=new et,Os=new gn;hn.forEach((e,t)=>{Os.load(e.image,n=>{n.anisotropy=w.capabilities.getMaxAnisotropy(),n.minFilter=Es,n.magFilter=An;const o=n.image.width,s=n.image.height,i=o/s,{ratioW:a,ratioH:l}=Wt(),r=Math.min(a,l);let c,f;e.fitByHeight?(f=window.innerHeight,c=f*i):(c=o*(e.size||1)*r,f=s*(e.size||1)*r);const u=new Pn(c,f);let p,m=null;if(e.selection)if(e.image_select){const g=Os.load(e.image_select);g.anisotropy=w.capabilities.getMaxAnisotropy(),g.minFilter=Es,g.magFilter=An,m=new q({map:g,transparent:!0,alphaTest:.01,side:ze,color:16777215})}else m=new q({map:n,transparent:!0,alphaTest:.01,side:ze,color:16777130});p=new q({map:n,transparent:!0,alphaTest:.01,side:ze,color:16777215});const h=new _e(u,p),T=e.x*a,y=e.y*l;if(h.position.set(T,y,e.z||0),h.userData={index:t,name:e.name,selection:e.selection===!0,normalMaterial:p,hoverMaterial:m,fitByHeight:e.fitByHeight,aspect:i,originalWidth:o,originalHeight:s,size:e.size||1},C.add(h),h.userData.name==="tour_1"){Ce=h;const g=Jt();g.name="selection_label",g.scale.set(150,38,75),g.position.set(0,120,0),console.log("label pour tour"),h.add(g)}})});function ma(){R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),v.aspect=window.innerWidth/window.innerHeight,v.updateProjectionMatrix(),so(),Re(P),console.log(v.position.z),w.setSize(window.innerWidth,window.innerHeight);const{ratioW:e,ratioH:t}=Wt(),n=Math.min(e,t);if(C.children.forEach(o=>{if(o.isMesh&&o.userData&&o.userData.name!="gamepadCursor"){const s=o.userData,i=hn[s.index].x*e,a=hn[s.index].y*t;o.name==="retour"?o.position.set(i+v.position.x,a+v.position.y,o.position.z):o.position.set(i,a,o.position.z),o.geometry.dispose();let l,r;s.fitByHeight?(r=window.innerHeight,l=r*s.aspect):(l=s.originalWidth*s.size*n,r=s.originalHeight*s.size*n),o.geometry=new Pn(l,r)}}),U){const o=U.userData.refPos.x,s=U.userData.refPos.y,i=U.userData.refScale;U.position.set(o*e,s*t,0),U.scale.set(i*n,i*n,i*n)}if(Y){const o=Y.userData.refPos.x,s=Y.userData.refPos.y,i=Y.userData.refScale;Y.position.set(o*e,s*t,0),Y.scale.set(i*n,i*n,i*n)}if(Q){const o=Q.userData.refPos.x,s=Q.userData.refPos.y,i=Q.userData.refScale;Q.position.set(o*e,s*t,0),Q.scale.set(i*n,i*n,i*n)}if(Z){const o=Z.userData.refPos.x,s=Z.userData.refPos.y,i=Z.userData.refScale;Z.position.set(o*e,s*t,0),Z.scale.set(i*n,i*n,i*n)}}const to=1280,no=551,ha=359;function Wt(){const e=window.innerWidth/to,t=window.innerHeight/no;return{ratioW:e,ratioH:t}}function so(){const e=window.innerWidth/to,t=window.innerHeight/no,n=Math.max(e,t);v.position.z=ha*n}so();document.addEventListener("mousemove",ga);document.addEventListener("click",e=>_a(e,Se));const We=new Set;function ga(e){Je.x=e.clientX/window.innerWidth*2-1,Je.y=-(e.clientY/window.innerHeight)*2+1,jt.setFromCamera(Je,v);const t=jt.intersectObjects(C.children,!0);if(C.children.forEach(n=>{n.isMesh&&n.userData.selection&&(n.material=n.userData.normalMaterial)}),t.length>0){const n=t[0].object;n.userData.selection&&(n.material=n.userData.hoverMaterial)}if(We.clear(),t.length>0){const n=t[0].object;C.traverse(o=>{o.name==="perso"&&(o===n||o.getObjectById(n.id))&&We.add(o),(o.userData.name==="tour_1"||o.userData.name==="tour_2"||o.userData.name==="tour_3")&&(o===n||o.getObjectById(n.id))&&We.add(o)})}}function wa(){C.traverse(e=>{if(e.name==="perso"){var t=We.has(e)?7:5;if(e.spec==1)var t=We.has(e)?7:5;if(e.spec==2)var t=We.has(e)?700:500;if(e.spec==3)var t=We.has(e)?7:5;if(e.spec==4)var t=We.has(e)?700:500;e.scale.x=$.lerp(e.scale.x,t,.1),e.scale.y=$.lerp(e.scale.y,t,.1),e.scale.z=$.lerp(e.scale.z,t,.1)}if(e.userData.name==="tour_1"||e.userData.name==="tour_2"||e.userData.name==="tour_3"){var t=We.has(e)?1.2:1;e.scale.x=$.lerp(e.scale.x,t,.1),e.scale.y=$.lerp(e.scale.y,t,.1),e.scale.z=$.lerp(e.scale.z,t,.1)}})}const ya=4,De=new Array(ya).fill(null);var P="home",O=[1,1,1,1];function _a(e,t){Je.x=e.clientX/window.innerWidth*2-1,Je.y=-(e.clientY/window.innerHeight)*2+1,jt.setFromCamera(Je,v);const n=jt.intersectObjects(C.children,!0);if(n.length>0){const o=n[0].object;o.userData.selection&&Re(o.userData.name)}if(n.length>0){let s=n[0].object;for(;s&&s.name!=="perso";)s=s.parent;if(s&&s.name==="perso")if(De[t]===s){De[t]=null;const i=s.getObjectByName("selection_label"+t);i&&s.remove(i)}else{if(De[t]){const a=De[t],l=a.getObjectByName("selection_label"+t);l&&a.remove(l)}De[t]=s;const i=Jt(t);i.name="selection_label"+t,s.spec==1&&(i.position.set(0,20,0),O[t]=1),s.spec==2&&(O[t]=2,i.position.set(0,.2,0),i.scale.set(.2,.05,.1)),s.spec==3&&(O[t]=3,i.position.set(0,20,0),i.scale.set(20,5,10)),s.spec==4&&(O[t]=4,i.position.set(0,.2,0),i.scale.set(.2,.05,.1)),i.position.y=i.position.y*(t==0?1:1+.3*t),s.add(i)}}}function xa(e){Je.x=e.clientX/window.innerWidth*2-1,Je.y=-(e.clientY/window.innerHeight)*2+1,jt.setFromCamera(Je,v);const t=jt.intersectObjects(C.children,!0);if(t.length>0){let n=t[0].object;for(;n&&!n.userData;)n=n.parent;if(n&&n.userData&&n.userData.selection&&(n.userData.name==="tour_1"||n.userData.name==="tour_2"||n.userData.name==="tour_3")){if(Ce===n)return;{if(Ce){const s=Ce.getObjectByName("selection_label");s&&Ce.remove(s)}Ce=n;const o=Jt();o.name="selection_label",o.scale.set(150,38,75),o.position.set(0,120,0),console.log("label pour tour"),n.add(o)}}}}document.addEventListener("click",xa);function Jt(e=0){const t=document.createElement("canvas");t.width=256,t.height=64;const n=t.getContext("2d");n.fillStyle=e==0?"#007bff":e==1?"#00ff0d":e==2?"#ffe600":"#ff0000",n.fillRect(0,0,t.width,t.height),n.fillStyle="#ffffff",n.font="28px Arial",n.textAlign="center",n.fillText("S\xE9lectionn\xE9",t.width/2,t.height/2+10);const o=new fs(t),s=new Wo({map:o}),i=new Uo(s);return i.scale.set(20,5,10),i}function Re(e){if(F==="select"){var t=window.innerWidth,n=window.innerHeight;e==="home"?(console.log("home"),P="home",Ge.copy(v.position),ke.set(t*0,n*0,v.position.z),qe=0,Ne=!0):e==="solo"?(Ge.copy(v.position),ke.set(t*0,n*1,v.position.z),qe=0,Ne=!0,P="solo",console.log("solo",ke)):e==="multi"?(console.log("multi"),P="multi",Ge.copy(v.position),ke.set(t*0,n*-1,v.position.z),qe=0,Ne=!0):e==="config"?(console.log("config"),P="config",Ge.copy(v.position),ke.set(t*0,n*2,v.position.z),qe=0,Ne=!0):e==="50cc"||e==="100cc"||e==="150cc"||e==="200cc"||e==="vitesse"||e==="retour_tour_multi"?(P==="solo"&&(P="perso_solo",oe=1),P==="multi"&&(P="nb_multi"),console.log(e),e==="50cc"&&(W=1),e==="100cc"&&(W=1.5),e==="150cc"&&(W=2),e==="200cc"&&(W=2.5),is(oe),Ge.copy(v.position),ke.set(t*1,P=="perso_solo"||e==="retour_tour_multi"?n*1:n*-1,v.position.z),qe=0,Ne=!0):e==="retour"?(console.log("retour"),(P=="multi"||P=="solo"||P=="config")&&Re("home"),P=="nb_multi"&&Re("multi"),P=="perso_solo"&&Re("solo"),P=="tour_solo"&&(P="perso_solo",Re("vitesse")),P=="tour_multi"&&(P="nb_multi",Re("retour_tour_multi")),P=="choice_multi"&&(P="nb_multi",Re("vitesse"))):e==="ok_solo_kart"?(console.log("ok_solo_kart"),oe==1?P="tour_solo":P="tour_multi",Ge.copy(v.position),ke.set(t*2,n*1,v.position.z),qe=0,Ne=!0):e==="tour_1"?ie=1:e==="tour_2"?ie=2:e==="tour_3"?ie=3:e==="ok_solo_tour"&&N!="run"?(console.log("ok_solo_tour"),P="home",Re("home"),ce=[0,0,0,0],N="start",oe==1?F="runsolo":oe==2?F="runsplit":oe==3?F="runsplit3":oe==4&&(F="runsplit4")):e==="player_1"?Se=0:e==="player_2"?Se=1:e==="player_3"?Se=2:e==="player_4"?Se=3:e==="2p"||e==="3p"||e==="4p"?(P="choice_multi",console.log(e),e==="2p"&&(oe=2),e==="3p"&&(oe=3),e==="4p"&&(oe=4),console.log(oe),is(oe),Ge.copy(v.position),ke.set(t*1,n*1,v.position.z),qe=0,Ne=!0):console.log("Action par d\xE9faut pour",e)}}function is(e){Se=0,C.children.forEach(t=>{if(t.userData&&t.userData.name){const n=t.userData.name;if(n.startsWith("player_")){const o=parseInt(n.split("_")[1],10);t.visible=o<=e}}if(t.name==="perso")for(let n=0;n<4;n++){const o=t.getObjectByName("selection_label"+n);o&&(o.visible=n<=e-1)}})}function xn(e){Qi(e),qi(e)}function Ps(e){e.traverse(t=>{t.isMesh&&(t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(n=>{n.map&&n.map.dispose(),n.dispose()}):(t.material.map&&t.material.map.dispose(),t.material.dispose())))})}function Ta(e){e.body&&(le.removeBody(e.body),e.body=null),e.mesh&&(M.remove(e.mesh),Ps(e.mesh),e.mesh=null),e.visualGroup&&(M.remove(e.visualGroup),Ps(e.visualGroup),e.visualGroup=null)}function Ma(){for(let e=0;e<re.length;e++)Ta(re[e]);re.length=0}function va(e,t,n){const o=new L;t==="left"?o.set(1,0,-3):o.set(-1,0,-3),o.applyQuaternion(e.quaternion),o.x+=(Math.random()-.5)*2,o.y+=(Math.random()-.5)*2,o.z+=(Math.random()-.5)*2;const s=new L().copy(e.position).add(o),i=Js(n);i.position.copy(s),M.add(i),pn.push(i)}function Un(e,t,n){const o={};return o.body=new $e({mass:200,shape:new Zt(new pe(8,3,12.5)),position:new pe(t.x,t.y,t.z)}),o.body.fixedRotation=!0,o.body.updateMassProperties(),le.addBody(o.body),o.mesh=new _e(new Yt(17,5,25),new q({color:16711680,wireframe:!0,visible:!1})),o.mesh.position.set(t.x,t.y,t.z),M.add(o.mesh),o.visualGroup=new vn,o.visualGroup.position.set(t.x,t.y,t.z),M.add(o.visualGroup),Le.load(e,s=>{o.model=s.scene,o.model.scale.set(n,n,n),o.model.traverse(i=>{if(i.isMesh){i.frustumCulled=!1;const a=i.material,l=i.material;let r=l.map||null;i.material=new q({map:r,color:l.color||16777215,side:ze}),a&&a.metalness!==void 0&&(a.roughness=.8,a.metalness=0,a.envMapIntensity=.5,a.toneMapped=!0,a.emissive.set(0))}}),o.model.position.set(0,-4,0),o.model.rotation.y=Math.PI,o.visualGroup.add(o.model)},void 0,console.error),o.started=!1,o.startDelay=5,o.elapsedTime=0,o.tour=0,o.checkpoints=["step_1","step_2","step_3","step_4"],o.tasksCompleted={},o.checkpoints.forEach(s=>{o.tasksCompleted[s]=!1}),o.phantom=!1,o.finished=!1,o.wasOnCheckpoint=!1,o}function Sa(e,t){const n=new L(0,0,-1).applyQuaternion(e.mesh.quaternion).setY(0).normalize(),o=e.mesh.position.clone();for(let s of St){const i=s.mesh.position.clone().sub(o);if(i.length()<t&&n.dot(i.normalize())>.7)return s}return null}function Jn(e,t,n=150,o=10){let s=0;const i=Math.floor(n/o);for(let a=1;a<=i;a++){const l=a*o,r=e.mesh.position.clone().add(t.clone().multiplyScalar(l));he("road",{position:r})&&s++}return s}function ba(e){const t=new Jo;t.setFromAxisAngle(new pe(0,1,0),Math.PI),e.body.quaternion=t.multipliedBy(e.body.quaternion),e.mesh.quaternion.copy(e.body.quaternion),e.visualGroup.quaternion.copy(e.body.quaternion)}function Vn(e,t){if(!e.started)if(e.elapsedTime+=t,e.elapsedTime>=e.startDelay)e.started=!0;else return;if(e.finished&&!e.phantom){e.body.velocity.set(0,0,0),e.body.angularVelocity.set(0,0,0),e.model.traverse(_=>{_.isMesh&&(_.material.transparent=!0,_.material.opacity=.5)});return}const n=new L(0,0,-1).applyQuaternion(e.mesh.quaternion).setY(0).normalize(),o=200,s=new L(-n.z,0,n.x).normalize(),i=s.clone().negate();let a=n.clone();const l=Jn(e,n,o,10),r=o/10;if(l<.7*r){const _=Jn(e,s,o,10),X=Jn(e,i,o,10);_>X?a.add(s.clone().multiplyScalar(.5)):a.add(i.clone().multiplyScalar(.5))}else{const _=e.mesh.position.clone().add(s.clone().multiplyScalar(o)),X=e.mesh.position.clone().add(i.clone().multiplyScalar(o));he("road",{position:_})||a.add(i.clone().multiplyScalar(.4)),he("road",{position:X})||a.add(s.clone().multiplyScalar(.4))}const c=Sa(e,o);if(c){const _=c.mesh.position.clone().sub(e.mesh.position).setY(0);n.dot(_.normalize())>.9?s.dot(_)>0?a.add(i.clone().multiplyScalar(.4)):a.add(s.clone().multiplyScalar(.4)):a.sub(_.normalize().multiplyScalar(.8))}typeof re!="undefined"&&re.forEach(_=>{if(_!==e&&!_.finished){const X=e.mesh.position.clone().sub(_.mesh.position),te=X.length();if(te<100&&te>0){const He=X.normalize().multiplyScalar((100-te)/100);a.add(He.multiplyScalar(.7))}}}),a.normalize();let f=n.angleTo(a);const p=new L().crossVectors(n,a).y>=0?1:-1;let m=.9;l<.7*r&&(m=.5);let h=p*m*W*f;const T=.1;e.body.angularVelocity.y=$.lerp(e.body.angularVelocity.y,h,T);const y=.2;if(e.driftTimer===void 0&&(e.driftTimer=0),e.boostTimer===void 0&&(e.boostTimer=0),Math.abs(h)>y){if(e.driftTimer+=t,e.driftTimer>.5){h*=2;let _=e.driftTimer<1.5?43775:16746496;va(e.mesh,p>0?"left":"right",_)}}else e.driftTimer>=1.5&&(e.boostTimer=1),e.driftTimer=0;e.body.angularVelocity.y=$.lerp(e.body.angularVelocity.y,h,T);let g=1;e.boostTimer>0&&(g=2,e.boostTimer-=t);const D=125*W*En(e.mesh)*g;e.body.velocity.x=a.x*D,e.body.velocity.z=a.z*D,e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion),e.visualGroup.position.copy(e.body.position),e.visualGroup.quaternion.copy(e.body.quaternion);const k=e.checkpoints.findIndex(_=>!e.tasksCompleted[_]);if(k!==-1){const _=e.checkpoints[k],X=e.mesh.position.clone().add(n.clone().multiplyScalar(2));he(_,{position:X})?(e.wasOnCheckpoint&&e.tasksCompleted[_]&&ba(e),e.tasksCompleted[_]=!0,e.wasOnCheckpoint=!0,e.tasksCompleted[_]=!0):e.wasOnCheckpoint=!1}e.checkpoints.every(_=>e.tasksCompleted[_])&&(e.tour+=1,e.tour>=ie&&(e.finished=!0,e.phantom!=!0&&dt.push({name:"Bot "+(re.indexOf(e)+1),rank:dt.length+1}),e.phantom=!0,e.model.traverse(_=>{_.isMesh&&(_.material.transparent=!0,_.material.opacity=.5)})),e.checkpoints.forEach(_=>{e.tasksCompleted[_]=!1}));let we=!0;for(let _=0;_<oe;_++)if(wt[_]==="run"){we=!1;break}we&&e.finished!=!0&&(e.finished=!0,e.phantom=!0,dt.push({name:"Bot "+(re.indexOf(e)+1),rank:dt.length+1}),e.tour=ie,e.checkpoints.forEach(_=>{e.tasksCompleted[_]=!0}))}let ge=null,_t=null,xt=null,Tt=null;window.addEventListener("gamepadconnected",e=>{const t=e.gamepad;console.log("Manette connect\xE9e :",t),ge===null?ge=t.index:_t===null?_t=t.index:xt===null?xt=t.index:Tt===null&&(Tt=t.index)});window.addEventListener("gamepaddisconnected",e=>{const t=e.gamepad;console.log("Manette d\xE9connect\xE9e :",t),ge===t.index?ge=null:_t===t.index?_t=null:xt===t.index?xt=null:Tt===t.index&&(Tt=null)});function Kn(e,t,n){const o=navigator.getGamepads();if(ge!==null&&o[ge]&&n>=1){const s=o[ge],i=s.axes[0],a=s.buttons[1].pressed,l=s.buttons[0].pressed;let r=s.buttons[7].pressed;const c=i<-.2,f=i>.2;r?c?(Ue=!0,Ve=!1):f?(Ve=!0,Ue=!1):(Ue=!1,Ve=!1,r=!1):(Ue=!1,Ve=!1),ot(S,A,R,a,l,c,f,E,1,e,t)}else n>=1&&ot(S,A,R,I.z,I.s,I.q,I.d,E,1,e,t);if(_t!==null&&o[_t]&&n>=2){const s=o[_t],i=s.axes[0],a=s.buttons[1].pressed,l=s.buttons[0].pressed;let r=s.buttons[7].pressed;const c=i<-.2,f=i>.2;r?c?(Ke=!0,Xe=!1):f?(Xe=!0,Ke=!1):(Ke=!1,Xe=!1,r=!1):(Ke=!1,Xe=!1),ot(B,V,ue,a,l,c,f,E,2,e,t)}else n>=2&&ot(B,V,ue,I.o,I.l,I.k,I.m,E,2,e,t);if(xt!==null&&o[xt]&&n>=3){const s=o[xt],i=s.axes[0],a=s.buttons[1].pressed,l=s.buttons[0].pressed;let r=s.buttons[7].pressed;const c=i<-.2,f=i>.2;r?c?(je=!0,Ye=!1):f?(Ye=!0,je=!1):(je=!1,Ye=!1,r=!1):(je=!1,Ye=!1),ot(J,ee,Ie,a,l,c,f,E,3,e,t)}else n>=3&&ot(J,ee,Ie,I.g,I.b,I.v,I.n,E,3,e,t);if(Tt!==null&&o[Tt]&&n>=4){const s=o[Tt],i=s.axes[0],a=s.buttons[1].pressed,l=s.buttons[0].pressed;let r=s.buttons[7].pressed;const c=i<-.2,f=i>.2;r?c?(Qe=!0,Ze=!1):f?(Ze=!0,Qe=!1):(Qe=!1,Ze=!1,r=!1):(Qe=!1,Ze=!1),ot(ve,fe,zt,a,l,c,f,E,4,e,t)}else n>=4&&ot(ve,fe,zt,I.arrowup,I.arrowdown,I.arrowleft,I.arrowright,E,4,e,t)}const oo=new gn,Tn=oo.load("Image/pro_control_upscaled.png"),Mn=oo.load("Image/pro_control_upscaled_disconnect.png");function Ea(){C.children.forEach(e=>{e.userData&&e.userData.name&&(e.userData.name==="mannette_1"?e.material.map=ge!==null?Tn:Mn:e.userData.name==="mannette_2"?e.material.map=_t!==null?Tn:Mn:e.userData.name==="mannette_3"?e.material.map=xt!==null?Tn:Mn:e.userData.name==="mannette_4"&&(e.material.map=Tt!==null?Tn:Mn),e.material.needsUpdate=!0)})}let de=null;function Aa(){const e=new ps(10,16,16),t=new q({color:16776960});de=new _e(e,t),de.userData={name:"gamepadCursor"},de.position.set(0,0,0),C.add(de)}Aa();let it=new et(0,0);function La(e){if(ge!==null){de.visible=!0;const t=navigator.getGamepads()[ge];if(t&&t.axes.length>=2){it.x+=t.axes[0]*500*e,it.y+=-t.axes[1]*500*e;const o=window.innerWidth/2,s=window.innerHeight/2;it.x=Math.max(-o,Math.min(o,it.x)),it.y=Math.max(-s,Math.min(s,it.y))}}else de.visible=!1;de.position.x=v.position.x+it.x,de.position.y=v.position.y+it.y,de.position.z=50}function Ra(){if(ge!==null){const e=navigator.getGamepads()[ge];if(e&&e.buttons[0].pressed){console.log("click");let t=de.position.clone();t.project(v);const n=new et(t.x,t.y),o=new Qt;o.setFromCamera(n,v);const s=o.intersectObjects(C.children,!0);if(s.length>1){const i=s[1].object;console.log("click on : ",i),i.userData&&i.userData.selection&&Re(i.userData.name)}}}}function Ia(){const e=de.position.clone();e.project(v);const t=new et(e.x,e.y),n=new Qt;n.setFromCamera(t,v);const o=n.intersectObjects(C.children,!0);if(o.length>1){const s=o[1].object;s.userData&&s.userData.selection&&(s.userData.hovered||(s.userData.originalTexture||(s.userData.originalTexture=s.material),s.material=s.userData.hoverMaterial,s.material.needsUpdate=!0,s.userData.hovered=!0))}else C.children.forEach(s=>{s.userData&&s.userData.hovered&&(s.userData.originalTexture&&(s.material=s.userData.originalTexture,s.material.needsUpdate=!0),s.userData.hovered=!1)})}function Da(){const e=de.position.clone();e.project(v);const t=new et(e.x,e.y),n=new Qt;n.setFromCamera(t,v);const o=n.intersectObjects(C.children,!0);if(o.length>1){const i=o[1].object;i.userData&&(i.userData.name==="tour_1"||i.userData.name==="tour_2"||i.userData.name==="tour_3")&&(i.userData.hovered||(i.userData.originalScale||(i.userData.originalScale=i.scale.clone()),i.userData.hovered=!0))}else C.children.forEach(i=>{i.userData&&(i.userData.name==="tour_1"||i.userData.name==="tour_2"||i.userData.name==="tour_3")&&i.userData.hovered&&(i.userData.originalScale,i.userData.originalTexture&&(i.material.map=i.userData.originalTexture,i.material.needsUpdate=!0),i.userData.hovered=!1)});if(o.length>1){var s=o[1].object;for(let i=0;i<2;i++){if(s.name==="perso"){console.log(s.hovered),s.hovered||(s.hovered=!0);break}s.parent!=null&&(s=s.parent)}}else C.children.forEach(i=>{i.name==="perso"&&i.hovered&&(i.hovered=!1)});C.children.forEach(i=>{if(i.userData.name==="tour_1"||i.userData.name==="tour_2"||i.userData.name==="tour_3"){var a=i.userData.hovered?1.2:1;i.scale.x=$.lerp(i.scale.x,a,.1),i.scale.y=$.lerp(i.scale.y,a,.1),i.scale.z=$.lerp(i.scale.z,a,.1)}if(i.name==="perso"){i.hovered&&console.log(i.spec);var a=i.hovered?7:5;if(i.spec==1)var a=i.hovered?7:5;if(i.spec==2)var a=i.hovered?700:500;if(i.spec==3)var a=i.hovered?7:5;if(i.spec==4)var a=i.hovered?700:500;i.scale.x=$.lerp(i.scale.x,a,.1),i.scale.y=$.lerp(i.scale.y,a,.1),i.scale.z=$.lerp(i.scale.z,a,.1)}})}function za(){const e=de.position.clone();e.project(v);const t=new et(e.x,e.y),n=new Qt;n.setFromCamera(t,v);const o=n.intersectObjects(C.children,!0);if(o.length>1){const s=o[1].object;if(s.userData&&(s.userData.name==="tour_1"||s.userData.name==="tour_2"||s.userData.name==="tour_3")){const i=s.getObjectByName("selection_label");if(i)s.remove(i);else{if(Ce){const l=Ce.getObjectByName("selection_label");l&&Ce.remove(l)}Ce=s;const a=Jt();a.name="selection_label",a.scale.set(150,38,75),a.position.set(0,120,0),console.log("label pour tour"),s.add(a)}}}}function Ha(){const e=de.position.clone();e.project(v);const t=new et(e.x,e.y),n=new Qt;n.setFromCamera(t,v);const o=n.intersectObjects(C.children,!0);o.length>1&&o[1].object.userData.selection;let s=Se;if(o.length>1){let a=o[1].object;for(;a&&a.name!=="perso";)a=a.parent;if(a&&a.name==="perso")if(De[s]===a){De[s]=null;const l=a.getObjectByName("selection_label"+s);l&&a.remove(l)}else{if(De[s]){const r=De[s],c=r.getObjectByName("selection_label"+s);c&&r.remove(c)}De[s]=a;const l=Jt(s);l.name="selection_label"+s,a.spec==1&&(l.position.set(0,20,0),O[s]=1),a.spec==2&&(O[s]=2,l.position.set(0,.2,0),l.scale.set(.2,.05,.1)),a.spec==3&&(O[s]=3,l.position.set(0,20,0)),a.spec==4&&(O[s]=4,l.position.set(0,.2,0),l.scale.set(.2,.05,.1)),l.position.y=l.position.y*(s==0?1:1+.3*s),a.add(l)}}}let tn=!1;function ka(e){const t=navigator.getGamepads()[ge];t?(La(e),Ia(),Da()):de.visible=!1,t&&t.buttons[0].pressed?tn||(Ra(),za(),Ha(),tn=!0):t&&t.buttons[1].pressed?tn||(Re("retour"),tn=!0):tn=!1}const io=new Xo;function ao(){const e=io.getDelta();requestAnimationFrame(ao),oa(),sa(),F==="select"?N!=="menu_select"?(oe=1,N="menu_select",P="home",oe=1,Se=0,is(oe),Ni(),Ki(),v.position.set(0,0,v.position.z)):(re.length!=0&&Ma(),Ea(),ua(),wa(),ka(e),fa(e),w.setSize(window.innerWidth,window.innerHeight),w.setViewport(0,0,window.innerWidth,window.innerHeight),w.setScissor(0,0,window.innerWidth,window.innerHeight),w.render(C,v)):F==="runsolo"?(xn(e),w.setSize(window.innerWidth,window.innerHeight),w.setViewport(0,0,window.innerWidth,window.innerHeight),w.setScissor(0,0,window.innerWidth,window.innerHeight),R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),ia(),w.render(M,R)):F==="stop"?w.render(M,R):F==="rundev"?(w.setSize(window.innerWidth,window.innerHeight),w.setViewport(0,0,window.innerWidth,window.innerHeight),w.setScissor(0,0,window.innerWidth,window.innerHeight),R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),ca(),w.render(M,R)):F==="runsplit"?(xn(e),R.aspect=window.innerWidth/2/window.innerHeight,R.updateProjectionMatrix(),ue.aspect=window.innerWidth/2/window.innerHeight,ue.updateProjectionMatrix(),w.setSize(window.innerWidth,window.innerHeight),w.setScissorTest(!0),aa(),w.setViewport(0,0,window.innerWidth/2,window.innerHeight),w.setScissor(0,0,window.innerWidth/2,window.innerHeight),w.render(M,R),w.setViewport(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight),w.setScissor(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight),w.render(M,ue)):F==="runsplit3"?(xn(e),R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),ue.aspect=window.innerWidth/window.innerHeight,ue.updateProjectionMatrix(),Ie.aspect=window.innerWidth/window.innerHeight,Ie.updateProjectionMatrix(),w.setSize(window.innerWidth,window.innerHeight),w.setScissorTest(!0),ra(),w.setViewport(0,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.setScissor(0,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.render(M,R),w.setViewport(window.innerWidth/2,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.setScissor(window.innerWidth/2,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.render(M,ue),w.setViewport(0,0,window.innerWidth/2,window.innerHeight/2),w.setScissor(0,0,window.innerWidth/2,window.innerHeight/2),w.render(M,Ie),w.setViewport(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight/2),w.setScissor(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight/2),w.render(M,ms)):F==="runsplit4"&&(xn(e),R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),ue.aspect=window.innerWidth/window.innerHeight,ue.updateProjectionMatrix(),Ie.aspect=window.innerWidth/window.innerHeight,Ie.updateProjectionMatrix(),zt.aspect=window.innerWidth/window.innerHeight,zt.updateProjectionMatrix(),w.setSize(window.innerWidth,window.innerHeight),w.setScissorTest(!0),la(),w.setViewport(0,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.setScissor(0,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.render(M,R),w.setViewport(window.innerWidth/2,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.setScissor(window.innerWidth/2,window.innerHeight/2,window.innerWidth/2,window.innerHeight/2),w.render(M,ue),w.setViewport(0,0,window.innerWidth/2,window.innerHeight/2),w.setScissor(0,0,window.innerWidth/2,window.innerHeight/2),w.render(M,Ie),w.setViewport(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight/2),w.setScissor(window.innerWidth/2,0,window.innerWidth/2,window.innerHeight/2),w.render(M,zt))}ao();window.addEventListener("resize",()=>{ma(),R.aspect=window.innerWidth/window.innerHeight,R.updateProjectionMatrix(),w.setSize(window.innerWidth,window.innerHeight),Ui()});
